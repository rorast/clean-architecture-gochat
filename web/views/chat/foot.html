{{define "chat/foot.html"}}
<script>

    function upload(dom) {
        if (!dom.files || !dom.files[0]) {
            mui.toast('請選擇圖片');
            return;
        }

        const file = dom.files[0];
        console.log('準備上傳的文件：', {
            name: file.name,
            type: file.type,
            size: file.size
        });

        const validTypes = ['image/gif', 'image/jpeg', 'image/png'];
        if (!validTypes.includes(file.type)) {
            mui.toast('只支持 GIF、JPEG、PNG 格式的圖片');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            mui.toast('圖片大小不能超過 5MB');
            return;
        }

        app.panelstat = 'kbord';

        uploadfile("attach/upload", dom, function (res) {
            console.log('上傳響應完整數據：', JSON.stringify(res, null, 2));
            if (res.Code == 0 || res.code == 200) {
                if (!app.isSending) {
                    app.isSending = true;
                    // 正確獲取圖片 URL
                    const imageUrl = res.data && res.data.file_url ? res.data.file_url : 
                                   res.Data && res.Data.file_url ? res.Data.file_url : null;
                    
                    if (!imageUrl) {
                        console.error('無法獲取圖片URL，完整響應：', JSON.stringify(res, null, 2));
                        mui.toast('上傳失敗：無法獲取圖片URL');
                        app.isSending = false;
                        return;
                    }
                    
                    console.log('圖片上傳成功，完整路徑：', {
                        originalUrl: imageUrl,
                        fullUrl: window.location.origin + imageUrl,
                        fileName: imageUrl.split('/').pop()
                    });
                    
                    // 直接檢查圖片是否存在
                    const checkImg = new Image();
                    checkImg.onload = function() {
                        console.log('圖片文件驗證成功：', imageUrl);
                        // 添加緊急模式：直接顯示圖片
                        app.emergencyDisplayImage(imageUrl);
                        app.sendpicmsg(imageUrl);
                    };
                    checkImg.onerror = function() {
                        console.error('圖片文件不存在或無法訪問：', imageUrl);
                        mui.toast('圖片文件不存在或無法訪問');
                    };
                    checkImg.src = imageUrl;
                    
                    setTimeout(() => {
                        app.isSending = false;
                    }, 1000);
                }
            } else {
                const errorMsg = res.message || res.Msg || '上傳失敗';
                console.error('上傳失敗：', errorMsg, '完整響應：', JSON.stringify(res, null, 2));
                mui.toast(errorMsg);
            }
        });
    }
    // 上傳圖片 創建群
    function uploadthis(dom) {
        // 確認是否有用戶ID
        const currentUserId = userId();
        if (!currentUserId) {
            console.error('上傳群頭像失敗：未登入或無法獲取用戶ID');
            alert('請先登入後再上傳群頭像');
            return;
        }
        
        console.log('上傳群頭像，擁有者ID:', currentUserId);
        
        // 使用修改後的 uploadfile 函數，傳入正確的參數
        uploadfile("attach/upload", dom, function (res) {
            console.log('群頭像上傳響應：', res);
            // 檢查響應格式，支持兩種成功狀態：Code=0 或 code=200
            if (res.Code == 0 || res.code == 200) {
                // 確定回應數據位置
                const responseData = res.Data || res.data || {};
                // 獲取文件URL
                const fileUrl = typeof responseData === 'string' ? responseData : (responseData.file_url || '');
                
                if (!fileUrl) {
                    console.error('群頭像URL為空');
                    alert('群頭像上傳失敗：無法獲取URL');
                    return;
                }
                
                console.log('群頭像上傳成功，URL：', fileUrl);
                
                // 更新群頭像
                app.com.icon = fileUrl;
                
                // 更新頁面上的群頭像元素
                const iconElement = document.getElementById('icon');
                if (iconElement) {
                    iconElement.src = fileUrl;
                }
                
                console.log('群頭像更新成功：', fileUrl);
                // 通知用戶
                mui.toast('群頭像上傳成功');
            } else {
                const errorMsg = res.message || res.Msg || '未知錯誤';
                console.error('群頭像上傳失敗：', errorMsg, res);
                alert('群頭像上傳失敗：' + errorMsg);
            }
        });
    }
    // 維護用戶頭像
    function uploadUserInfo(dom) {
        // 確認是否有用戶ID
        const currentUserId = userId();
        if (!currentUserId) {
            console.error('上傳頭像失敗：未登入或無法獲取用戶ID');
            alert('請先登入後再上傳頭像');
            return;
        }
        
        console.log('上傳頭像，用戶ID:', currentUserId);
        
        uploadfile("attach/upload", dom, function (res) {
            console.log('頭像上傳響應：', res);
            // 檢查響應格式，支持兩種成功狀態：Code=0 或 code=200
            if (res.Code == 0 || res.code == 200) {
                // 確定回應數據位置
                const responseData = res.Data || res.data || {};
                // 獲取文件URL
                const fileUrl = typeof responseData === 'string' ? responseData : (responseData.file_url || '');
                
                if (!fileUrl) {
                    console.error('頭像URL為空');
                    alert('頭像上傳失敗：無法獲取URL');
                    return;
                }
                
                console.log('頭像上傳成功，URL：', fileUrl);
                
                // 更新所有相關的頭像顯示
                app.info.icon = fileUrl;
                app.profile.avatar = fileUrl;
                
                // 更新 sessionStorage 中的用戶信息
                let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                userInfo.Avatar = fileUrl;
                sessionStorage.setItem('userinfo', JSON.stringify(userInfo));
                
                // 更新頁面上的所有頭像元素
                const avatarElements = document.querySelectorAll('img[src*="avatar"]');
                avatarElements.forEach(element => {
                    if (element.id === 'userAvatar' || element.classList.contains('avatar')) {
                        element.src = fileUrl;
                    }
                });
                
                console.log('頭像更新成功：', fileUrl);
                // 通知用戶
                mui.toast('頭像更新成功');
            } else {
                const errorMsg = res.message || res.Msg || '未知錯誤';
                console.error('頭像上傳失敗：', errorMsg, res);
                alert('頭像上傳失敗：' + errorMsg);
            }
        });
    }



    function userId() {
        const id = parseInt(util.parseQuery("userId"));
        console.log('🎯 用戶id：', id);
        return id;
    }
    var app = new Vue(
        {
            el: "#pageapp",
            data: {
                usermap: {},
                friends: [],
                communitys: [],
                profile: {
                    avatar: "",
                    nickname: "",
                    memo: "",
                },
                webSocket: null,
                win: "main",
                com: {
                    "ownerId": "",
                    "icon": "",
                    "cate": "",
                    "name": "",
                    "memo": "",
                    "size": "0",
                    "joinType": "0"
                },
                //用户信息
                info: {
                    "id": "",
                    "icon": "",
                    "name": "",
                },
                isDisable: true,
                isLoadMore: false,
                start: 0,
                end: 9,
                txtmsg: "",
                panelstat: "kbord",
                txtstat: "kbord",
                title: "",
                otherAvatar: '',
                doutu: {
                    config: {
                        "baseurl": "web/asset/plugins/doutu",
                        "pkgids": ["mkgif", "emoj"]
                    },
                    packages: [],
                    choosed: { "pkgid": "emoj", "assets": [], "size": "small" }
                },
                msglist: [],
                isReadRedisMsg: [],  //是否已读取某个用户的缓存消息
                msgcontext: {
                    TargetId: -1,
                    Type: -1,
                    CreateTime: new Date().getTime(),
                    userId: userId()
                },
                plugins: [
                    {
                        icon: "icon-tupian",
                        name: "照片",
                        id: "upload",
                        slot: "<input accept=\"image/gif,image/jpeg,image/png\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },
                    {
                        icon: "icon-paizhao",
                        name: "拍照",
                        id: "camera",
                        slot: "<input accept=\"image/*\" capture=\"camera\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },
                    {
                        icon: "icon-emoji",
                        name: "表情",
                        id: "emoji",
                        slot: "<div onclick=\"showEmojiPicker()\" class='emoji-btn'></div>"
                    },
                    {
                        icon: "icon-yuyin",
                        name: "語音",
                        id: "audiocall"
                    },
                    {
                        icon: "icon-shipin",
                        name: "視頻",
                        id: "videocall"
                    },
                    {
                        icon: "icon-hongbao",
                        name: "紅包",
                        id: "redpackage"
                    },
                    {
                        icon: "icon-zhuanzhang",
                        name: "轉帳",
                        id: "exchange"
                    },
                    {
                        icon: "icon-daohangdizhi",
                        name: "地址",
                        id: "address"
                    },
                    {
                        icon: "icon-zhanghu",
                        name: "名片",
                        id: "person"
                    }
                ],
                timer: 0,
                recorder: {},
                allChunks: [],
                iscomplete: false,
                duration: 0,
                showprocess: false,
                reconnectAttempts: 0,
                maxReconnectAttempts: 5,
                messageQueue: [],
                isConnecting: false,
                processedMessages: {},
                isSending: false,  // 添加發送狀態標記
                currentPage: 1,
                isLoadingHistory: false,
                hasMoreHistory: true,
                lastScrollPosition: 0,
                scrollThreshold: 100, // 新增：滾動閾值
                debounceTimer: null, // 新增：防抖動計時器
                loadingIndicator: false, // 新增：載入指示器狀態
                imageLoaded: true, // 設置為 true 防止初始加載指示器顯示
            },
            created: function () {
                this.loadfriends();
                this.loadcommunitys();
                this.loaddoutures();
                setInterval(this.heartbeat, 10 * 1000);
                var user = userInfo()
                // 初始化 websocket
                this.initWebSocket()
                this.initUser();

                // 設置全局圖片處理器，方便調試
                window.addEventListener('error', (event) => {
                    if (event.target.tagName === 'IMG') {
                        console.error('全局圖片載入錯誤:', {
                            src: event.target.src,
                            message: event.message
                        });
                    }
                }, true);
            },
            mounted: function () {
                // 檢查所有圖片的可訪問性
                setTimeout(() => {
                    this.checkAllImages();
                }, 2000);
            },
            methods: {
                // 檢查所有圖片
                checkAllImages: function() {
                    console.log('檢查所有圖片元素');
                    const allImages = document.querySelectorAll('img.pic');
                    if (allImages.length === 0) {
                        console.log('未找到任何圖片元素');
                        
                        // 檢查聊天容器
                        const chatThread = document.querySelector('.chat-thread');
                        if (!chatThread) {
                            console.error('找不到聊天容器 .chat-thread');
                            return;
                        }
                        
                        // 檢查是否有消息項目
                        const chatItems = chatThread.querySelectorAll('li.chat');
                        console.log(`找到 ${chatItems.length} 個聊天項目`);
                        
                        // 檢查消息列表數據
                        console.log('當前消息列表數據:', this.msglist);
                        
                        // 檢查圖片容器
                        const imageContainers = document.querySelectorAll('.image-container');
                        console.log(`找到 ${imageContainers.length} 個圖片容器`);
                        
                        // 如果消息列表中有圖片消息但DOM中沒有圖片元素，嘗試強制更新
                        const hasImageMessages = this.msglist.some(item => item.msg && item.msg.Media === 4);
                        if (hasImageMessages) {
                            console.log('消息列表中有圖片消息，但DOM中沒有圖片元素，嘗試強制更新');
                            this.$forceUpdate();
                        }
                        
                        return;
                    }
                    
                    console.log(`找到 ${allImages.length} 個圖片元素，開始檢查`);
                    
                    allImages.forEach((img, index) => {
                        console.log(`圖片 ${index+1}:`, {
                            src: img.src,
                            visible: this.isElementVisible(img),
                            size: {
                                width: img.width,
                                height: img.height
                            },
                            naturalSize: {
                                width: img.naturalWidth,
                                height: img.naturalHeight
                            },
                            style: img.getAttribute('style') || '無樣式',
                            className: img.className
                        });
                        
                        // 如果圖片加載完成但沒有顯示，嘗試強制更新
                        if (img.complete && img.naturalWidth === 0) {
                            console.warn(`圖片 ${index+1} 加載完成但尺寸為零，嘗試重新加載`);
                            const currentSrc = img.src;
                            img.src = '';
                            setTimeout(() => {
                                img.src = currentSrc;
                            }, 100);
                        }
                    });
                },
                // 檢查元素是否可見
                isElementVisible: function(el) {
                    if (!el) return false;
                    
                    const rect = el.getBoundingClientRect();
                    const vWidth = window.innerWidth || document.documentElement.clientWidth;
                    const vHeight = window.innerHeight || document.documentElement.clientHeight;
                    
                    // 檢查元素是否在視窗內
                    if (
                        rect.right < 0 ||
                        rect.bottom < 0 ||
                        rect.left > vWidth ||
                        rect.top > vHeight
                    ) {
                        return false;
                    }
                    
                    // 檢查元素尺寸
                    if (rect.width === 0 || rect.height === 0) {
                        return false;
                    }
                    
                    return true;
                },
                
                // 檢查URL是否為有效的圖片URL
                isValidImageUrl: function(url) {
                    if (!url) return false;
                    
                    // 確保不是純數字或簡單文本
                    if (/^\d+$/.test(url) || url.length < 4) {
                        return false;
                    }
                    
                    // 檢查是否包含圖片檔案副檔名
                    const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
                    const hasExtension = validExtensions.some(ext => 
                        url.toLowerCase().includes(ext)
                    );
                    
                    // 如果包含檔案副檔名或包含檔案路徑，則認為是有效的圖片URL
                    return hasExtension || 
                           url.includes('/asset/files/') || 
                           url.includes('/web/asset/') ||
                           url.includes('file_');
                },
                
                handleAvatarError(e) {
                    console.warn('頭像載入失數，使用預設頭像');
                    e.target.src = '/web/asset/images/avatar0.png';
                },
                initUser() {
                    let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                    // 確保頭像 URL 正確
                    let avatarUrl = userInfo.Avatar;
                    if (avatarUrl && !avatarUrl.startsWith('http') && !avatarUrl.startsWith('/')) {
                        avatarUrl = '/web/asset/images/' + avatarUrl;
                    }
                    
                    this.info.icon = avatarUrl;
                    this.info.name = userInfo.Name;
                    this.info.id = userInfo.ID;
                    this.profile.avatar = avatarUrl;
                    this.profile.nickname = userInfo.Name;
                    
                    console.log('初始化用戶信息：', {
                        icon: this.info.icon,
                        avatar: this.profile.avatar,
                        name: this.info.name
                    });
                },
                playaudio: function (url) {
                    document.getElementById('audio4play').src = url;
                    document.getElementById('audio4play').play();
                },
                startrecorder: function () {
                    let audioTarget = document.getElementById('audio');
                    var types = ["video/webm",
                        "audio/webm",
                        "video/webm\;codecs=vp8",
                        "video/webm\;codecs=daala",
                        "video/webm\;codecs=h264",
                        "audio/webm\;codecs=opus",
                        "video/mpeg"];
                    var suporttype = "";
                    for (var i in types) {
                        if (MediaRecorder.isTypeSupported(types[i])) {
                            suporttype = types[i];
                        }
                    }
                    if (!suporttype) {
                        mui.toast("編碼不支持")
                        return;
                    }

                    this.duration = new Date().getTime();
                    //video 攝像頭   ，audio 音頻
                    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                        .then(function (stream) {
                            this.showprocess = true
                            this.recorder = new MediaRecorder(stream);
                            audioTarget.srcObject = stream;
                            // 是否可用
                            this.recorder.ondataavailable = (event) => {
                                console.log("ondataavailable");
                                uploadblob("attach/upload", event.data, ".mp3", res => {
                                    var duration = Math.ceil((new Date().getTime() - this.duration) / 1000);
                                    this.sendaudiomsg(res.Data, duration);
                                })
                                stream.getTracks().forEach(function (track) {
                                    track.stop();
                                });
                                this.showprocess = false
                            }
                            this.recorder.start();
                        }.bind(this)).
                        catch(function (err) {
                            console.log(err)
                            mui.toast(err)
                            this.showprocess = false
                        }.bind(this));
                },
                stoprecorder: function () {
                    if (typeof this.recorder.stop == "function") {
                        this.recorder.stop();
                    }
                    this.showprocess = false
                    console.log("stoprecorder")

                },
                dispatchplugin: function (item) {
                    switch (item.id) {
                        case "upload":
                        case "camera":

                            break;
                        default:
                            mui.toast("系統暫不支持，請自行擴展")
                    }
                },
                reset: function () {
                    this.panelstat = "kbord";
                    this.txtstat = "kbord";
                    this.txtmsg = "";
                },
                createmsgcontext: function () {
                    return {
                        TargetId: this.msgcontext.TargetId,
                        Type: this.msgcontext.Type,
                        CreateTime: new Date().getTime(),
                        userId: userId(),
                        Media: 1, // 默認文字類型
                        Content: "",
                        Url: "",
                        Amount: 0
                    };
                },
                loaddoutures: function () {
                    var res = [];
                    var config = this.doutu.config;
                    for (var i in config.pkgids) {
                        res[config.pkgids[i]] = (config.baseurl + "/" + config.pkgids[i] + "/info.json")
                    }
                    var that = this;
                    for (var id in res) {
                        this.$http.get(res[id]).then(response => {
                            pkginfo = response.data
                            var baseurl = config.baseurl + "/" + pkginfo.id + "/"
                            // console.log("post res[i]",id,res[id],pkginfo)
                            for (var j in pkginfo.assets) {
                                pkginfo.assets[j] = baseurl + pkginfo.assets[j];
                            }
                            pkginfo.icon = baseurl + pkginfo.icon;
                            that.doutu.packages.push(pkginfo)
                            if (that.doutu.choosed.pkgid == pkginfo.id) {
                                that.doutu.choosed.assets = pkginfo.assets;
                            }

                        })
                    }
                },
                showweixin: function () {
                    mui.alert("請加微信號xxx索取")
                },
                showmsg: function (user, msg, isReverse, isFirst) {
                    console.log('顯示消息：', {
                        user: user,
                        msg: msg,
                        isReverse: isReverse,
                        isFirst: isFirst
                    });

                    const currentUserId = parseInt(util.parseQuery("userId"));
                    
                    // 標準化消息格式，確保兼容兩種屬性命名風格
                    const normalizedMsg = {
                        ...msg,
                        Type: msg.Type || msg.type || 1,
                        Media: Number(msg.Media || msg.media || 1),  // 確保 Media 是數字類型
                        media: Number(msg.Media || msg.media || 1),  // 同時設置小寫版本，確保一致性
                        Content: msg.Content || msg.content || "",
                        content: msg.Content || msg.content || "",  // 同時設置小寫版本
                        user_id: msg.user_id || msg.userId,
                        userId: msg.userId || msg.user_id,
                        target_id: msg.target_id || msg.TargetId,
                        TargetId: msg.TargetId || msg.target_id,
                        url: msg.url || msg.Url || msg.Content || msg.content || "",
                        Url: msg.url || msg.Url || msg.Content || msg.content || ""  // 確保大寫版本也有值
                    };
                    
                    // 如果是圖片消息，輸出特定的日誌並嘗試直接渲染
                    if (normalizedMsg.Media === 4) {
                        console.log('圖片消息詳情：', {
                            原始消息: msg,
                            標準化後: normalizedMsg,
                            原始URL屬性: {
                                url: msg.url,
                                Url: msg.Url,
                                content: msg.content,
                                Content: msg.Content
                            },
                            標準化URL: normalizedMsg.url,
                            完整URL: window.location.origin + (normalizedMsg.url || '')
                        });
                        
                        // 檢查圖片URL是否有效
                        if (this.isValidImageUrl(normalizedMsg.url)) {
                            // 如果圖片URL有效，輸出調試信息並直接測試圖片
                            console.log('有效的圖片URL，嘗試直接測試:', normalizedMsg.url);
                            this.testImageDirectly(normalizedMsg.url);
                        } else {
                            // 如果圖片URL無效，輸出警告
                            console.warn('無效的圖片URL:', normalizedMsg.url);
                        }
                    }
                    
                    var data = {
                        ismine: (normalizedMsg.user_id === currentUserId || normalizedMsg.userId === currentUserId),
                        user: user,
                        msg: normalizedMsg
                    };
                    
                    console.log('處理後的消息數據：', data);
                    
                    // 圖片消息特殊處理，確保渲染時有完整屬性
                    if (data.msg.Media === 4) {
                        data.msg.url = data.msg.url || data.msg.Url || data.msg.Content;
                        data.msg.Url = data.msg.url;
                        data.msg.Content = data.msg.url;
                    }
                    
                    if (isReverse) {
                        this.msglist = [data].concat(this.msglist);
                    } else {
                        if (isFirst) {
                            this.msglist = [data].concat(this.msglist);
                        } else {
                            this.msglist = this.msglist.concat(data)
                        }
                    }
                    
                    if (!isReverse) {
                        this.panelstat = "kbord";
                    }
                    
                    var that = this;
                    that.timer = setTimeout(function () {
                        window.scrollTo(0, document.getElementById("convo").offsetHeight);
                        if (!isReverse) {
                            let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                            let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                            let y = scroll - inner - 80;
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                        } else {
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + 0 + 'px)';
                        }
                        clearTimeout(that.timer)
                    }, 100)
                },
                startrecord: function () {

                },
                // 跟誰單聊
                sendtxtmsg: function (txt) {
                    if (!txt.trim()) return;
                    
                    // 檢查是否有目標用戶
                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("請先選擇聊天對象", this.msgcontext);
                        mui.toast("請先選擇聊天對象");
                        return;
                    }

                    console.log("發送消息，上下文:", this.msgcontext);
                    
                        var msg = this.createmsgcontext();
                        msg.Content = txt;
                    msg.Media = 1; // 文字類型
                    msg.TargetId = this.msgcontext.TargetId; // 確保設置目標ID
                    msg.Type = this.msgcontext.Type; // 確保設置消息類型
                    
                    console.log("準備發送的消息:", msg);
                    
                    // 先顯示消息
                            this.showmsg(userInfo(), msg);
                    
                    // 清空輸入框
                    this.txtmsg = "";
                    
                    // 發送到服務器
                    this.sendMessageToServer(msg);
                },
                sendpicmsg: function (url) {
                    if (this.isSending) {
                        return;
                    }
                    this.isSending = true;

                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("請先選擇聊天對象", this.msgcontext);
                        mui.toast("請先選擇聊天對象");
                        this.isSending = false;
                        return;
                    }

                    // 確保URL格式正確
                    if (url && !url.startsWith('http') && !url.startsWith('/')) {
                        url = '/' + url;
                    }

                    console.log('準備發送圖片消息：', {
                        url: url,
                        fullUrl: window.location.origin + url,
                        fileName: url.split('/').pop(),
                        targetId: this.msgcontext.TargetId,
                        type: this.msgcontext.Type
                    });

                    // 創建標準化的圖片消息對象
                    const currentUserId = parseInt(util.parseQuery("userId"));
                    const msgObj = {
                        userId: currentUserId,
                        TargetId: this.msgcontext.TargetId,
                        Type: this.msgcontext.Type,
                        Media: 4,  // 一定要是數字，不能是字符串
                        media: 4,  // 小寫屬性也設置
                        url: url,
                        Url: url,
                        Content: url,
                        CreateTime: new Date().toISOString(),
                        id: new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9)
                    };
                    
                    console.log('創建的消息對象：', msgObj);
                    
                    // 直接創建消息數據並添加到列表
                    const msgData = {
                        ismine: true,
                        user: userInfo(),
                        msg: msgObj
                    };
                    
                    console.log('準備將圖片消息添加到列表', {
                        消息對象: msgObj,
                        Media數值: msgObj.Media,  // 檢查Media屬性是否為數字
                        消息數據: msgData
                    });
                    
                    // 將新消息添加到列表
                    this.msglist.push(msgData);
                    
                    // 確保消息被處理
                    if (!this.processedMessages) {
                        this.processedMessages = {};
                    }
                    this.processedMessages[msgObj.id] = true;
                    
                    // 發送到服務器
                    this.sendMessageToServer(msgObj);
                    
                    // 強制 Vue 更新視圖
                    this.$nextTick(() => {
                        this.$forceUpdate();
                        
                        // 滾動到底部
                        setTimeout(() => {
                            window.scrollTo(0, document.getElementById("convo").offsetHeight);
                            let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                            let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                            let y = scroll - inner - 80;
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                            
                            // 查看更新後的圖片元素
                            this.checkAllImages();
                        }, 200);
                    });
                    
                    // 重設發送狀態
                    setTimeout(() => {
                        this.isSending = false;
                    }, 1000);
                },
                sendaudiomsg: function (url, duration) {
                        var msg = this.createmsgcontext();
                    msg.Url = url;
                    msg.Media = 3; // 語音類型
                    msg.Amount = duration;
                    
                    // 先顯示消息
                            this.showmsg(userInfo(), msg);
                    
                    // 發送到服務器
                    this.sendMessageToServer(msg);
                },
                scrollConcat() {
                    console.log(123)
                },
                closePanel() {
                    this.panelstat = 'kbord';
                },
                singlemsg: function (user) {
                    // 檢查用戶對象是否有效
                    if (!user) {
                        console.error("用戶對象為空");
                        mui.toast("無法獲取用戶信息");
                        return;
                    }

                    // 檢查必要的用戶屬性
                    if (!user.ID && !user.id) {
                        console.error("用戶ID無效:", user);
                        mui.toast("用戶ID無效");
                        return;
                    }

                    // 統一使用 ID 屬性
                    const userId = user.ID || user.id;
                    const userName = user.name || user.Name;
                    const userAvatar = user.Avatar || user.avatar;

                    // 確保頭像URL正確
                    let avatarUrl = userAvatar;
                    if (avatarUrl && !avatarUrl.startsWith("http") && !avatarUrl.startsWith("/")) {
                        avatarUrl = "/web/asset/images/" + avatarUrl;
                    }

                    console.log("開始聊天，用戶信息:", {
                        id: userId,
                        name: userName,
                        avatar: avatarUrl
                    });
                    
                    if (this.isDisable) {
                        this.setTimeFlag();
                        this.win = "single";
                        this.title = "和【" + userName + "】聊天中";
                        this.otherAvatar = avatarUrl || "/web/asset/images/avatar0.png";
                        
                        // 確保正確設置目標ID和類型
                        const targetId = parseInt(userId);
                        if (isNaN(targetId)) {
                            console.error("用戶ID無效:", userId);
                            mui.toast("用戶ID無效");
                            return;
                        }
                        
                        // 重置消息列表和分頁信息
                        this.msglist = [];
                        this.currentPage = 1;
                        this.isLoadingHistory = false;
                        this.hasMoreHistory = true;
                        this.lastScrollPosition = 0;
                        
                        // 重要：先設置上下文，然後立即加載歷史記錄
                        this.msgcontext = {
                            TargetId: targetId,
                            Type: 1, // 私聊類型
                            CreateTime: new Date().getTime(),
                            userId: this.info.id || util.parseQuery("userId")
                        };
                        
                        console.log("設置聊天上下文:", this.msgcontext);
                        
                        // 加載聊天歷史
                        this.loadMoreHistory();
                        
                        // 使用 Vue 的 nextTick 確保 DOM 已更新
                        this.$nextTick(() => {
                            // 設置滾動
                            const scrollWrapper = document.querySelector('.mui-scroll-wrapper');
                            if (scrollWrapper) {
                                mui(scrollWrapper).scroll({
                                    scrollY: true,
                                    scrollX: false,
                                    startX: 0,
                                    startY: 0,
                                    indicators: true,
                                    deceleration: 0.0006,
                                    bounce: true
                                });

                                // 監聽滾動事件
                                const scrollElement = scrollWrapper.querySelector('.mui-scroll');
                                if (scrollElement) {
                                    scrollElement.addEventListener('scroll', this.handleScroll);
                                }
                            }
                            
                            // 添加診斷工具
                            this.addDiagnosticTools();
                        });
                    }
                },
                // 處理滾動事件
                handleScroll: function(e) {
                    if (!e.target || !e.target.style || this.isLoadingHistory || !this.hasMoreHistory) {
                        return;
                    }

                    // 清除之前的防抖動計時器
                    if (this.debounceTimer) {
                        clearTimeout(this.debounceTimer);
                    }

                    const transform = e.target.style.transform;
                    if (!transform) {
                        return;
                    }

                    const translate = transform.match(/translate3d\(\d+px,\s*(\d+)px,\s*(\d+)px\)/i);
                    if (!translate || translate.length <= 1) {
                        return;
                    }

                    const currentPosition = parseInt(translate[1]);
                    const scrollDiff = Math.abs(currentPosition - this.lastScrollPosition);

                    // 使用防抖動處理滾動事件
                    this.debounceTimer = setTimeout(() => {
                        // 只有當滾動距離超過閾值時才觸發載入
                        if (scrollDiff > this.scrollThreshold && currentPosition > this.lastScrollPosition) {
                            this.loadingIndicator = true; // 顯示載入指示器
                            this.loadMoreHistory();
                        }
                    }, 200); // 200ms 的防抖動延遲

                    this.lastScrollPosition = currentPosition;
                },
                loadMoreHistory: function() {
                    if (this.isLoadingHistory || !this.hasMoreHistory) {
                        return;
                    }

                    // 檢查必要的參數
                    if (!this.msgcontext.userId || !this.msgcontext.TargetId) {
                        console.error('無效的用戶ID或目標ID:', this.msgcontext);
                        mui.toast('無法載入歷史記錄：參數無效');
                        return;
                    }

                    // 檢查消息類型
                    if (![1, 2].includes(this.msgcontext.Type)) {
                        console.error('無效的消息類型:', this.msgcontext.Type);
                        mui.toast('無法載入歷史記錄：消息類型無效');
                        return;
                    }

                    this.isLoadingHistory = true;
                    const nextPage = this.currentPage + 1;

                    // 顯示載入中提示
                    const loadingToast = document.createElement('div');
                    loadingToast.className = 'loading-toast';
                    loadingToast.innerHTML = `
                        <style>
                            .loading-toast {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: rgba(0, 0, 0, 0.7);
                                color: white;
                                padding: 10px 20px;
                                border-radius: 5px;
                                z-index: 9999;
                            }
                            .loading-spinner {
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                border: 2px solid #fff;
                                border-radius: 50%;
                                border-top-color: transparent;
                                animation: spin 1s linear infinite;
                                margin-right: 10px;
                            }
                            @keyframes spin {
                                to {transform: rotate(360deg);}
                            }
                        </style>
                        <div class="loading-spinner"></div>
                        <span>載入中...</span>
                    `;
                    document.body.appendChild(loadingToast);

                    // 根據消息類型選擇正確的 API 路徑
                    const endpoint = this.msgcontext.Type === 1 ? 
                        `/chat/private/history?page=${nextPage}&pageSize=20&fromUserId=${this.msgcontext.userId}&toUserId=${this.msgcontext.TargetId}` :
                        `/chat/group/history?page=${nextPage}&pageSize=20&groupId=${this.msgcontext.TargetId}&userId=${this.msgcontext.userId}`;

                    fetch(endpoint, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        try {
                            if (!text || text.trim() === '') {
                                return { code: 0, data: [] };
                            }
                            return JSON.parse(text);
                        } catch (e) {
                            console.error("解析響應失敗:", e);
                            throw new Error("無效的響應格式");
                        }
                    })
                    .then(res => {
                        if (res.code === 0) {
                            const messages = res.data || [];
                            
                            // 如果沒有更多消息，標記已到達底部
                            if (messages.length === 0) {
                                this.hasMoreHistory = false;
                                mui.toast("已經沒有更多記錄了");
                                return;
                            }

                            // 按時間順序排序消息
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

                            // 顯示消息
                            const currentUserId = parseInt(util.parseQuery("userId"));
                            messages.forEach((msg, index) => {
                                const messageData = {
                                    ...msg,
                                    type: 1,
                                    media: msg.media || 1,
                                    user_id: msg.user_id,
                                    target_id: msg.target_id,
                                    content: msg.content
                                };

                                if (messageData.user_id === currentUserId) {
                                    this.loaduserinfo(messageData.user_id, (user) => {
                                        this.showmsg(user, messageData, true);
                                    });
                                } else {
                                    this.loaduserinfo(messageData.user_id, (user) => {
                                        this.showmsg(user, messageData, true);
                                    });
                                }
                            });

                            this.currentPage = nextPage;
                        }
                    })
                    .catch(error => {
                        console.error("載入歷史記錄失敗:", error);
                        mui.toast("載入歷史記錄失敗，請稍後重試");
                        this.hasMoreHistory = false;
                    })
                    .finally(() => {
                        this.isLoadingHistory = false;
                        this.loadingIndicator = false;
                        // 移除載入中提示
                        const loadingToast = document.querySelector('.loading-toast');
                        if (loadingToast) {
                            loadingToast.remove();
                        }
                    });
                },
                // 群聊的初始化
                groupmsg: function (group) {
                    if (this.isDisable) {
                        this.setTimeFlag()
                        this.win = "group";
                        this.title = group.name;
                        this.msgcontext.TargetId = parseInt(group.id);
                        this.msgcontext.Type = 2;
                    }
                },
                loaduserinfo: function (userid, cb) {
                    if (!userid) {
                        console.error("用戶ID無效");
                        return;
                    }
                    
                    userid = "" + userid;
                    var userinfo = this.usermap[userid];
                    
                    if (!userinfo) {
                        // 只在首次加載時輸出日誌
                        console.log("首次加載用戶信息:", userid);
                        
                        fetch("/user/find", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({ userId: parseInt(userid) })
                        })
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(res => {
                            if (res.code === 0 && res.data) {
                                // 確保頭像URL正確
                                if (res.data.Avatar && !res.data.Avatar.startsWith("http")) {
                                    res.data.Avatar = "/web/asset/images/" + res.data.Avatar;
                                }
                                this.usermap[userid] = res.data;
                                cb(res.data);
                    } else {
                                console.error("獲取用戶信息失敗:", res.message);
                                // 使用預設頭像
                                const defaultUser = {
                                    ID: parseInt(userid),
                                    Name: "未知用戶",
                                    Avatar: "/web/asset/images/avatar0.png"
                                };
                                this.usermap[userid] = defaultUser;
                                cb(defaultUser);
                            }
                        })
                        .catch(err => {
                            console.error("加載用戶信息失敗:", err);
                            // 使用預設頭像
                            const defaultUser = {
                                ID: parseInt(userid),
                                Name: "未知用戶",
                                Avatar: "/web/asset/images/avatar0.png"
                            };
                            this.usermap[userid] = defaultUser;
                            cb(defaultUser);
                        });
                    } else {
                        // 使用緩存時不輸出日誌
                        cb(userinfo);
                    }
                },
                onmessage: function (data) {
                    // 檢查是否為心跳消息
                    if (data.Media === -1 && data.Type === 3) {
                        return;
                    }

                    // 檢查是否已經處理過這條消息
                    if (this.processedMessages && this.processedMessages[data.id]) {
                        return;
                    }

                    // 標記消息為已處理
                    if (!this.processedMessages) {
                        this.processedMessages = {};
                    }
                    this.processedMessages[data.id] = true;

                    // 如果是自己的消息，直接返回（因為已經在發送時顯示過了）
                    if (data.userId === userId()) {
                        return;
                    }

                    // 處理對方的消息
                    this.loaduserinfo(data.userId, function (user) {
                        this.showmsg(user, data);

                        // 更新好友列表中的最後一條消息
                        this.friends.forEach((item) => {
                            if (item.ID == data.userId) {
                                // 1文字 2表情包 3圖片 4音頻
                                if (data.Media === 1) {
                                    item.memo = data.Content;
                                } else if (data.Media === 2) {
                                    item.memo = data.Url;
                                } else if (data.Media === 3) {
                                    item.memo = "[語音]";
                                } else if (data.Media === 4) {
                                    item.memo = "[圖片]";
                                }
                            }
                        });
                    }.bind(this));
                },
                initWebSocket() {
                    const currentUserId = userId(); // 使用全局函數
                    if (!currentUserId) {
                        console.error('無法初始化 WebSocket：未找到用戶 ID');
                        return;
                    }

                    if (this.isConnecting) {
                        console.log("WebSocket 正在連接中，跳過重連");
                        return;
                    }

                    this.isConnecting = true;

                    const wsUrl = `ws://${window.location.host}/chat/ws?userId=${currentUserId}`;
                    console.log("正在連接 WebSocket:", wsUrl);

                    try {
                        this.webSocket = new WebSocket(wsUrl);

                        this.webSocket.onopen = () => {
                            console.log('WebSocket 連接已建立');
                            this.isConnecting = false;
                            this.reconnectAttempts = 0;
                            this.startHeartbeat();
                            this.processMessageQueue();
                        };

                        this.webSocket.onmessage = (event) => {
                            try {
                                const message = JSON.parse(event.data);
                                console.log("收到 WebSocket 消息:", message);
                                
                                // 忽略心跳消息
                                if (message.Media === -1 && message.Type === 3) {
                                    return;
                                }

                                // 檢查是否已處理過該消息
                                if (this.processedMessages && this.processedMessages[message.id]) {
                                    console.log("消息已處理，跳過:", message.id);
                                    return;
                                }

                                // 標記消息為已處理
                                if (!this.processedMessages) {
                                    this.processedMessages = {};
                                }
                                this.processedMessages[message.id] = true;

                                // 如果是自己發送的消息，不需要再顯示
                                if (message.userId === currentUserId) {
                                    return;
                                }

                                // 確保消息格式標準化
                                const normalizedMessage = {
                                    ...message,
                                    user_id: message.userId,  // 兼容後端格式
                                    target_id: message.TargetId,  // 兼容後端格式
                                    content: message.Content,  // 兼容後端格式
                                    type: message.Type,        // 兼容後端格式
                                    media: message.Media       // 兼容後端格式
                                };
                                
                                // 確保圖片消息有正確的 url 屬性
                                if (message.Media === 4) {
                                    // 檢查可能的圖片URL來源
                                    normalizedMessage.url = message.Url || message.url || message.Content;
                                    
                                    console.log("處理圖片消息:", {
                                        原始消息: message,
                                        標準化後: normalizedMessage,
                                        圖片屬性: {
                                            Url: message.Url,
                                            url: message.url,
                                            Content: message.Content
                                        },
                                        最終URL: normalizedMessage.url,
                                        完整URL路徑: window.location.origin + (normalizedMessage.url || '')
                                    });
                                    
                                    // 如果沒有找到任何URL，輸出警告
                                    if (!normalizedMessage.url) {
                                        console.error("警告：無法從消息中提取圖片URL", message);
                                    }
                                }

                                // 處理接收到的消息
                                this.loaduserinfo(message.userId, (user) => {
                                    this.showmsg(user, normalizedMessage);
                                });
                            } catch (error) {
                                console.error("處理 WebSocket 消息時出錯:", error);
                            }
                        };

                        this.webSocket.onerror = (error) => {
                            console.error('WebSocket 錯誤：', error);
                            this.isConnecting = false;
                        };

                        this.webSocket.onclose = () => {
                            console.log('WebSocket 連接已關閉');
                            this.isConnecting = false;
                            // 嘗試重新連接
                            setTimeout(() => this.initWebSocket(), 5000);
                        };
                    } catch (error) {
                        console.error("初始化 WebSocket 時出錯:", error);
                        this.isConnecting = false;
                        setTimeout(() => this.initWebSocket(), 5000);
                    }
                },
                handleIncomingMessage(message) {
                    // 根據訊息類型處理接收到的訊息
                    if (message.type === 1) { // 私人訊息
                        this.msglist.push({
                            ismine: false,
                            msg: message
                        });
                    } else if (message.type === 2) { // 群組訊息
                        this.msglist.push({
                            ismine: false,
                            msg: message
                        });
                    }
                    // 滾動到最新訊息
                    this.$nextTick(() => {
                        const container = document.querySelector('.mui-scroll');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },
                async sendtxtmsg(content) {
                    if (!content.trim()) return;
                    
                    const currentUserId = userId(); // 使用全局函數
                    if (!currentUserId) {
                        console.error("未找到用戶ID");
                        mui.toast("請先登入");
                        return;
                    }

                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("請先選擇聊天對象", this.msgcontext);
                        mui.toast("請先選擇聊天對象");
                        return;
                    }

                    const message = {
                        fromUserId: currentUserId,
                        toUserId: this.msgcontext.TargetId,
                        content: content,
                        type: this.msgcontext.Type,
                        media: 1
                    };

                    try {
                        // 先在本地顯示消息
                        const localMsg = {
                            userId: message.fromUserId,
                            TargetId: message.toUserId,
                            Content: message.content,
                            Type: message.type,
                            Media: message.media,
                            CreatedAt: new Date()
                        };
                        this.showmsg(userInfo(), localMsg);

                        // 清空輸入框
                        this.txtmsg = '';

                        // 發送到 WebSocket
                        this.sendMessageToServer({
                            ...localMsg,
                            id: new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9)
                        });

                        // 同時發送到 HTTP API
                        const endpoint = message.type === 1 ? '/chat/private/send' : '/chat/group/send';
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify(message)
                        });

                        if (!response.ok) {
                            throw new Error('發送訊息失敗');
                        }
                    } catch (error) {
                        console.error('發送訊息失敗：', error);
                        mui.toast('發送訊息失敗，請稍後重試');
                    }
                },
                async sendpicmsg(url) {
                    if (this.isSending) return;
                    this.isSending = true;

                    const currentUserId = userId(); // 使用全局函數
                    if (!currentUserId) {
                        console.error("未找到用戶ID");
                        mui.toast("請先登入");
                        this.isSending = false;
                        return;
                    }

                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("請先選擇聊天對象", this.msgcontext);
                        mui.toast("請先選擇聊天對象");
                        this.isSending = false;
                        return;
                    }

                    const message = {
                        fromUserId: currentUserId,
                        toUserId: this.msgcontext.TargetId,
                        content: url,
                        type: this.msgcontext.Type,
                        media: 4
                    };

                    try {
                        // 先在本地顯示消息
                        const localMsg = {
                            userId: message.fromUserId,
                            TargetId: message.toUserId,
                            Content: message.content,
                            Type: message.type,
                            Media: message.media,
                            url: url,
                            CreatedAt: new Date()
                        };
                        this.showmsg(userInfo(), localMsg);

                        // 發送到 WebSocket
                        this.sendMessageToServer({
                            ...localMsg,
                            id: new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9)
                        });

                        // 同時發送到 HTTP API
                        const endpoint = message.type === 1 ? '/chat/private/send' : '/chat/group/send';
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify(message)
                        });

                        if (!response.ok) {
                            throw new Error('發送圖片失敗');
                        }

                        // 關閉面板
                        this.panelstat = 'kbord';
                    } catch (error) {
                        console.error('發送圖片失敗：', error);
                        mui.toast('發送圖片失敗，請稍後重試');
                    } finally {
                        setTimeout(() => {
                            this.isSending = false;
                        }, 1000);
                    }
                },
                sendMessageToServer: function (msg) {
                    if (!msg || !msg.TargetId || msg.TargetId <= 0) {
                        console.error("無效的消息或目標ID:", msg);
                        return;
                    }

                    // 生成消息ID
                    msg.id = new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        this.webSocket.send(JSON.stringify(msg));
                        } else {
                        console.log("WebSocket 未連接，消息加入隊列");
                        this.messageQueue.push(msg);
                        if (!this.isConnecting) {
                            this.initWebSocket();
                        }
                    }
                },
                startHeartbeat: function () {
                    if (this.heartbeatTimer) {
                        clearInterval(this.heartbeatTimer);
                    }
                    
                    // 每 60 秒發送一次心跳
                    this.heartbeatTimer = setInterval(() => {
                        if (this.webSocket && this.webSocket.readyState === 1) {
                            this.heartbeat();
                        }
                    }, 60000);
                },
                heartbeat() {
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        var msg = this.createmsgcontext();
                        msg.Media = -1;
                        msg.Type = 3;
                        msg.Content = "心跳";
                        this.webSocket.send(JSON.stringify(msg));
                    }
                },
                loadfriends: function () {
                    fetch("/user/searchFriends", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        },
                        body: JSON.stringify({
                            userId: userId()
                        })
                    })
                        .then(response => response.json())
                        .then(res => {
                        if (res.code === 0) {
                            this.friends = res.rows || [];
                            let usermap = {};
                            for (let i in this.friends) {
                                const k = "" + this.friends[i].id;
                                usermap[k] = this.friends[i];
                            }
                            console.log("好友列表加載完成:", this.friends);
                            console.log("用戶映射:", usermap);
                            this.usermap = usermap;
                        } else {
                            console.error("加載好友列表失敗:", res.message);
                        }
                        })
                        .catch(err => {
                        console.error("加載好友列表請求失敗:", err);
                        });
                },
                loadcommunitys: function () {
                    fetch(`/contact/groups?userId=${userId()}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        }
                    })
                    .then(response => response.json())
                    .then(res => {
                        if (res.code === 0) {
                            this.communitys = res.data || [];
                        } else {
                            console.error("加載群組列表失敗:", res.message);
                        }
                    })
                    .catch(err => {
                        console.error("加載群組列表請求失敗:", err);
                    });
                },
                addfriend: function () {
                    //console.log("addfriend....")
                    var that = this;
                    mui.prompt('', '請輸入好友名稱', '加好友', ['取消', '確認'], function (e) {
                        if (e.index == 1) {
                            console.log('🎯 好友名稱：', e.value);
                            // 判斷數字
                            //if (isNaN(e.value) || e.value <= 0) {
                            //    mui.toast('格式錯誤');
                            //} else {
                            //mui.toast(e.value);
                            that._addfriend(e.value)
                            //}
                        } else {
                            //mui.toast('您取消了入庫');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';

                },
                _addfriend: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        
                        fetch("/contact/addFriend", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({
                                userId: userId(),
                                targetId: parseInt(dstobj)
                            })
                        })
                            .then(response => response.json())
                            .then(res => {
                            if (res.code === 0) {
                                    mui.toast("添加成功");
                                    that.loadfriends();
                                } else {
                                mui.toast(res.message || "添加失敗");
                                }
                            })
                            .catch(err => {
                            console.error("添加好友請求失敗:", err);
                            mui.toast("網絡錯誤");
                            });
                    }
                },
                // 各人資料修改顯示
                setUserInfo: function () {
                    this.win = "userinfo"
                    //  console.log("createCom")
                },
                // 新建群顯示
                createCom: function () {
                    this.win = "community"
                    // 初始化群聊數據
                    this.com = {
                        ownerId: userId(),
                        icon: "",
                        cate: "0",
                        name: "",
                        memo: "",
                        size: "0",
                        joinType: "0"
                    }
                },

                // 新建群提交
                createcommunity: function () {
                    // 驗證表單
                    if (!this.com.name || this.com.name.length < 2 || this.com.name.length > 20) {
                        mui.toast("群名稱長度必須在2-20個字符之間");
                        return;
                    }
                    
                    if (!this.com.memo || this.com.memo.length > 200) {
                        mui.toast("群介紹不能超過200字");
                        return;
                    }
                    
                    if (!this.com.icon) {
                        mui.toast("請上傳群頭像");
                        return;
                    }

                    this.com.ownerId = userId();
                    
                    fetch("/contact/create-group", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        },
                        body: JSON.stringify(this.com)
                    })
                    .then(response => response.json())
                    .then(res => {
                        if (res.code === 0) {
                            mui.toast("建群成功");
                            this.loadcommunitys();
                            this.goBack(); // 返回上一頁
                        } else {
                            mui.toast(res.message || "建群失敗");
                        }
                    })
                    .catch(err => {
                        console.error("創建群組請求失敗:", err);
                        mui.toast("網絡錯誤");
                    });
                },
                updateUserInfo() {
                    //console.log("createcommunity")
                    this.info.id = userId()
                    util.post("/user/updateUser", this.info).then(res => {
                        console.log(res)
                        let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                        userInfo.Avatar = this.info.icon;
                        userInfo.Name = this.info.name;
                        sessionStorage.setItem('userinfo', JSON.stringify(userInfo))
                        if (res.Code != 0) {
                            mui.toast(res.message)
                        } else {
                            //location.replace("localhost:8081")
                            //location.href = "/"
                            mui.toast("修改成功")
                            //goBack()
                        }
                    })
                },



                //回到聊天首页
                goBack() {
                    this.win = "main"
                },

                _joincomunity: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        console.log(that);
                        fetch("/contact/joinGroup", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({
                                comId: dstobj,
                                userId: userId()
                            })
                        })
                        .then(response => response.json())
                        .then(res => {
                            if (res.code === 0) {
                                mui.toast("加入成功");
                                that.loadcommunitys();
                            } else {
                                mui.toast(res.message || "加入失敗");
                            }
                        })
                        .catch(err => {
                            console.error("加入群組請求失敗:", err);
                            mui.toast("網絡錯誤");
                        });
                    }
                },
                joincom: function () {
                    var that = this;
                    mui.prompt('', '请输入群号或者群名称', '加群', ['取消', '确认'], function (e) {
                        if (e.index == 1) {
                            //    if (isNaN(e.value) || e.value <= 0) {
                            //       mui.toast('格式错误');
                            //   } else {
                            //mui.toast(e.value);
                            that._joincomunity(e.value)
                            // }
                        } else {
                            //mui.toast('您取消了入库');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';
                },
                quit: function () {
                    sessionStorage.removeItem("userid")
                    sessionStorage.removeItem("userinfo")
                    location.href = "/"
                },
                setTimeFlag() {
                    this.isDisable = false;
                    setTimeout(() => {
                        this.isDisable = true;
                    }, 100)
                },
                // 添加 emoji 選擇器
                showEmojiPicker() {
                    // 檢查是否已存在表情選擇器
                    const existingPicker = document.querySelector('.emoji-picker');
                    if (existingPicker) {
                        document.body.removeChild(existingPicker);
                        return;
                    }

                    var emojiContainer = document.createElement('div');
                    emojiContainer.className = 'emoji-picker';
                    emojiContainer.style.position = 'absolute';
                    emojiContainer.style.bottom = '50px';
                    emojiContainer.style.left = '0';
                    emojiContainer.style.backgroundColor = '#fff';
                    emojiContainer.style.border = '1px solid #ccc';
                    emojiContainer.style.padding = '10px';
                    emojiContainer.style.zIndex = '1000';
                    emojiContainer.style.display = 'grid';
                    emojiContainer.style.gridTemplateColumns = 'repeat(8, 1fr)';
                    emojiContainer.style.gap = '5px';

                    // 加載 emoji 列表
                    var emojis = [];
                    for (var i = 1; i <= 13; i++) {
                        emojis.push(i + '.gif');
                    }

                    // 創建 emoji 按鈕
                    emojis.forEach(function(emoji) {
                        var emojiBtn = document.createElement('img');
                        emojiBtn.src = '/web/asset/plugins/doutu/emoj/' + emoji;
                        emojiBtn.style.width = '24px';
                        emojiBtn.style.height = '24px';
                        emojiBtn.style.cursor = 'pointer';
                        emojiBtn.onclick = function() {
                            app.sendpicmsg('/web/asset/plugins/doutu/emoj/' + emoji);
                            document.body.removeChild(emojiContainer);
                        };
                        emojiContainer.appendChild(emojiBtn);
                    });

                    // 添加關閉按鈕
                    var closeBtn = document.createElement('button');
                    closeBtn.textContent = '關閉';
                    closeBtn.style.gridColumn = '1 / -1';
                    closeBtn.style.marginTop = '10px';
                    closeBtn.onclick = function() {
                        document.body.removeChild(emojiContainer);
                    };
                    emojiContainer.appendChild(closeBtn);

                    document.body.appendChild(emojiContainer);
                },
                // 處理圖片加載錯誤
                handleImageError: function(e, msg) {
                    console.error('圖片加載失敗：', {
                        元素: e.target,
                        訊息: msg,
                        圖片來源: e.target.src,
                        完整消息對象: msg
                    });
                    
                    // 嘗試其他可能的圖片屬性
                    if (e.target.src !== msg.Url && msg.Url) {
                        console.log('嘗試使用 Url 屬性加載圖片:', msg.Url);
                        e.target.src = msg.Url;
                        return;
                    }
                    
                    if (e.target.src !== msg.Content && msg.Content) {
                        console.log('嘗試使用 Content 屬性加載圖片:', msg.Content);
                        e.target.src = msg.Content;
                        return;
                    }
                    
                    // 如果都失敗了，顯示錯誤圖片
                    e.target.src = '/web/asset/images/image-error.png';
                    mui.toast('圖片加載失敗');
                },
                
                // 圖片加載成功
                handleImageSuccess: function(e, msg) {
                    console.log('圖片加載成功：', {
                        元素: e.target,
                        圖片來源: e.target.src,
                        寬高: {
                            width: e.target.naturalWidth,
                            height: e.target.naturalHeight
                        },
                        消息對象: msg
                    });
                    
                    this.imageLoaded = true;
                },
                
                // 預覽圖片
                previewImage: function(url) {
                    if (!url) {
                        console.error('無效的圖片URL');
                        return;
                    }
                    
                    console.log('準備預覽圖片:', url);
                    
                    // 確保 URL 是完整的
                    const fullUrl = url.startsWith('http') ? url : 
                                  url.startsWith('/') ? window.location.origin + url : 
                                  window.location.origin + '/' + url;
                    
                    console.log('使用完整路徑預覽圖片:', fullUrl);
                    
                    // 創建預覽容器
                    const previewContainer = document.createElement('div');
                    previewContainer.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 9999;
                    `;
                    
                    // 創建圖片元素
                    const img = document.createElement('img');
                    img.src = fullUrl;
                    img.style.cssText = `
                        max-width: 90%;
                        max-height: 90%;
                        object-fit: contain;
                    `;
                    
                    // 添加加載狀態
                    const loadingText = document.createElement('div');
                    loadingText.textContent = '圖片加載中...';
                    loadingText.style.cssText = `
                        color: white;
                        font-size: 18px;
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                    `;
                    previewContainer.appendChild(loadingText);
                    
                    // 圖片加載完成後
                    img.onload = function() {
                        console.log('預覽圖片加載成功');
                        previewContainer.removeChild(loadingText);
                        previewContainer.appendChild(img);
                    };
                    
                    // 圖片加載失敗
                    img.onerror = function() {
                        console.error('預覽圖片加載失敗:', fullUrl);
                        loadingText.textContent = '圖片加載失敗';
                    };
                    
                    // 點擊關閉預覽
                    previewContainer.onclick = function() {
                        document.body.removeChild(previewContainer);
                    };
                    
                    document.body.appendChild(previewContainer);
                },
                // 檢查圖片是否可以訪問
                checkImageExists: function(url) {
                    return new Promise((resolve, reject) => {
                        if (!url) {
                            resolve(false);
                            return;
                        }
                        
                        // 確保完整URL
                        const fullUrl = url.startsWith('http') ? url : 
                                      window.location.origin + (url.startsWith('/') ? url : '/' + url);
                        
                        console.log('檢查圖片URL可訪問性:', fullUrl);
                        
                        // 直接嘗試在頁面上添加一個測試圖片
                        this.testImageDirectly(fullUrl);
                        
                        const img = new Image();
                        img.onload = function() {
                            resolve(true);
                        };
                        img.onerror = function() {
                            resolve(false);
                        };
                        img.src = fullUrl;
                        
                        // 設置超時
                        setTimeout(() => {
                            resolve(false);
                        }, 5000);
                    });
                },
                // 直接測試圖片URL
                testImageDirectly: function(imageUrl) {
                    console.log('直接測試圖片URL:', imageUrl);
                    
                    // 建立測試容器
                    const testContainer = document.createElement('div');
                    testContainer.id = 'image-test-container';
                    testContainer.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: white;
                        border: 1px solid #ccc;
                        padding: 10px;
                        z-index: 9999;
                    `;
                    
                    // 建立圖片元素
                    const testImage = document.createElement('img');
                    testImage.src = imageUrl;
                    testImage.style.cssText = `
                        max-width: 100px;
                        max-height: 100px;
                        display: block;
                    `;
                    
                    // 添加URL文字
                    const urlText = document.createElement('div');
                    urlText.textContent = '測試圖片: ' + imageUrl;
                    urlText.style.cssText = `
                        font-size: 10px;
                        word-break: break-all;
                        margin-top: 5px;
                    `;
                    
                    // 監聽圖片載入事件
                    testImage.onload = function() {
                        testContainer.style.borderColor = 'green';
                        console.log('測試圖片載入成功');
                    };
                    
                    testImage.onerror = function() {
                        testContainer.style.borderColor = 'red';
                        console.error('測試圖片載入失敗');
                    };
                    
                    // 添加關閉按鈕
                    const closeButton = document.createElement('button');
                    closeButton.textContent = '關閉';
                    closeButton.style.cssText = `
                        margin-top: 5px;
                        width: 100%;
                    `;
                    closeButton.onclick = function() {
                        document.body.removeChild(testContainer);
                    };
                    
                    // 添加到頁面
                    testContainer.appendChild(testImage);
                    testContainer.appendChild(urlText);
                    testContainer.appendChild(closeButton);
                    
                    // 移除舊的測試容器
                    const oldContainer = document.getElementById('image-test-container');
                    if (oldContainer) {
                        document.body.removeChild(oldContainer);
                    }
                    
                    document.body.appendChild(testContainer);
                },
                
                // 緊急模式：直接在聊天界面顯示圖片
                emergencyDisplayImage: function(imageUrl) {
                    console.log('緊急模式：直接顯示圖片', imageUrl);
                    
                    // 確保有聊天容器
                    const chatThread = document.querySelector('.chat-thread');
                    if (!chatThread) {
                        console.error('找不到聊天容器 .chat-thread');
                        return;
                    }
                    
                    // 創建一個新的聊天消息元素
                    const li = document.createElement('li');
                    li.className = 'chat mine';
                    
                    // 添加頭像
                    const avatarDiv = document.createElement('div');
                    const avatarImg = document.createElement('img');
                    avatarImg.className = 'avatar right';
                    avatarImg.src = this.info.icon || '/web/asset/images/avatar0.png';
                    avatarDiv.appendChild(avatarImg);
                    
                    // 添加空白span
                    const span = document.createElement('span');
                    
                    // 添加內容容器
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content';
                    
                    // 添加圖片容器
                    const imageContainerDiv = document.createElement('div');
                    imageContainerDiv.className = 'image-container';
                    
                    // 添加圖片
                    const img = document.createElement('img');
                    img.className = 'pic';
                    img.src = imageUrl;
                    img.alt = '圖片消息';
                    img.onclick = () => this.previewImage(imageUrl);
                    
                    // 構建DOM結構
                    imageContainerDiv.appendChild(img);
                    contentDiv.appendChild(imageContainerDiv);
                    
                    li.appendChild(avatarDiv);
                    li.appendChild(span);
                    li.appendChild(contentDiv);
                    
                    // 添加到聊天界面
                    chatThread.appendChild(li);
                    
                    // 滾動到底部
                    setTimeout(() => {
                        window.scrollTo(0, document.getElementById("convo").offsetHeight);
                        let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                        let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                        let y = scroll - inner - 80;
                        document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                    }, 100);
                },
                
                // 添加診斷工具
                addDiagnosticTools: function() {
                    // 移除舊的診斷工具
                    const oldTools = document.getElementById('diagnostic-tools');
                    if (oldTools) {
                        document.body.removeChild(oldTools);
                    }
                    
                    // 創建診斷工具容器
                    const toolsContainer = document.createElement('div');
                    toolsContainer.id = 'diagnostic-tools';
                    toolsContainer.style.cssText = `
                        position: fixed;
                        bottom: 70px;
                        right: 10px;
                        background: rgba(255, 255, 255, 0.9);
                        border: 1px solid #ccc;
                        padding: 10px;
                        z-index: 9999;
                        border-radius: 5px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    `;
                    
                    // 添加標題
                    const title = document.createElement('div');
                    title.textContent = '診斷工具';
                    title.style.fontWeight = 'bold';
                    title.style.marginBottom = '10px';
                    
                    // 添加檢查按鈕
                    const checkBtn = document.createElement('button');
                    checkBtn.textContent = '檢查圖片元素';
                    checkBtn.style.display = 'block';
                    checkBtn.style.margin = '5px 0';
                    checkBtn.style.width = '100%';
                    checkBtn.onclick = () => this.checkAllImages();
                    
                    // 添加強制更新按鈕
                    const updateBtn = document.createElement('button');
                    updateBtn.textContent = '強制更新視圖';
                    updateBtn.style.display = 'block';
                    updateBtn.style.margin = '5px 0';
                    updateBtn.style.width = '100%';
                    updateBtn.onclick = () => {
                        console.log('強制更新視圖');
                        this.$forceUpdate();
                        setTimeout(() => this.checkAllImages(), 100);
                    };
                    
                    // 添加顯示消息結構按鈕
                    const showMsgBtn = document.createElement('button');
                    showMsgBtn.textContent = '顯示消息結構';
                    showMsgBtn.style.display = 'block';
                    showMsgBtn.style.margin = '5px 0';
                    showMsgBtn.style.width = '100%';
                    showMsgBtn.onclick = () => {
                        console.log('顯示消息列表:', JSON.stringify(this.msglist, null, 2));
                    };
                    
                    // 添加顯示DOM結構按鈕
                    const showDomBtn = document.createElement('button');
                    showDomBtn.textContent = '顯示DOM結構';
                    showDomBtn.style.display = 'block';
                    showDomBtn.style.margin = '5px 0';
                    showDomBtn.style.width = '100%';
                    showDomBtn.onclick = () => {
                        const chatThread = document.querySelector('.chat-thread');
                        console.log('聊天容器結構:', chatThread ? chatThread.innerHTML : '找不到聊天容器');
                    };
                    
                    // 添加關閉按鈕
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = '關閉工具';
                    closeBtn.style.display = 'block';
                    closeBtn.style.margin = '5px 0';
                    closeBtn.style.width = '100%';
                    closeBtn.style.marginTop = '10px';
                    closeBtn.onclick = function() {
                        document.body.removeChild(toolsContainer);
                    };
                    
                    // 構建DOM結構
                    toolsContainer.appendChild(title);
                    toolsContainer.appendChild(checkBtn);
                    toolsContainer.appendChild(updateBtn);
                    toolsContainer.appendChild(showMsgBtn);
                    toolsContainer.appendChild(showDomBtn);
                    toolsContainer.appendChild(closeBtn);
                    
                    // 添加到頁面
                    document.body.appendChild(toolsContainer);
                },
                processMessageQueue: function() {
                    if (!this.messageQueue || this.messageQueue.length === 0) {
                        console.log("消息隊列為空，無需處理");
                        return;
                    }
                    
                    console.log(`處理消息隊列，共有 ${this.messageQueue.length} 條待發送消息`);
                    
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        // 依次發送隊列中的消息
                        while (this.messageQueue.length > 0) {
                            const msg = this.messageQueue.shift();
                            console.log("從隊列發送消息:", msg);
                            this.webSocket.send(JSON.stringify(msg));
                        }
                        console.log("消息隊列處理完成");
                    } else {
                        console.warn("WebSocket 連接未就緒，無法處理消息隊列");
                    }
                },
            },
            watch: {
                "win": function (n, o) {
                    // console.log("watch",o,n)
                    if (n != "main") {
                        document.getElementById("menubar").style.display = "none";
                    } else {
                        document.getElementById("menubar").style.display = "block";
                    }
                }
            }
        }
    )

</script>
{{end}}