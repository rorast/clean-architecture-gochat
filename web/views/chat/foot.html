{{define "chat/foot.html"}}
<script>

    function upload(dom) {
        if (!dom.files || !dom.files[0]) {
            mui.toast('è«‹é¸æ“‡åœ–ç‰‡');
            return;
        }

        const file = dom.files[0];
        console.log('æº–å‚™ä¸Šå‚³çš„æ–‡ä»¶ï¼š', {
            name: file.name,
            type: file.type,
            size: file.size
        });

        const validTypes = ['image/gif', 'image/jpeg', 'image/png'];
        if (!validTypes.includes(file.type)) {
            mui.toast('åªæ”¯æŒ GIFã€JPEGã€PNG æ ¼å¼çš„åœ–ç‰‡');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            mui.toast('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
            return;
        }

        app.panelstat = 'kbord';

        uploadfile("attach/upload", dom, function (res) {
            console.log('ä¸Šå‚³éŸ¿æ‡‰å®Œæ•´æ•¸æ“šï¼š', JSON.stringify(res, null, 2));
            if (res.Code == 0 || res.code == 200) {
                if (!app.isSending) {
                    app.isSending = true;
                    // æ­£ç¢ºç²å–åœ–ç‰‡ URL
                    const imageUrl = res.data && res.data.file_url ? res.data.file_url : 
                                   res.Data && res.Data.file_url ? res.Data.file_url : null;
                    
                    if (!imageUrl) {
                        console.error('ç„¡æ³•ç²å–åœ–ç‰‡URLï¼Œå®Œæ•´éŸ¿æ‡‰ï¼š', JSON.stringify(res, null, 2));
                        mui.toast('ä¸Šå‚³å¤±æ•—ï¼šç„¡æ³•ç²å–åœ–ç‰‡URL');
                        app.isSending = false;
                        return;
                    }
                    
                    console.log('åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼Œå®Œæ•´è·¯å¾‘ï¼š', {
                        originalUrl: imageUrl,
                        fullUrl: window.location.origin + imageUrl,
                        fileName: imageUrl.split('/').pop()
                    });
                    
                    app.sendpicmsg(imageUrl);
                    
                    setTimeout(() => {
                        app.isSending = false;
                    }, 1000);
                }
            } else {
                const errorMsg = res.message || res.Msg || 'ä¸Šå‚³å¤±æ•—';
                console.error('ä¸Šå‚³å¤±æ•—ï¼š', errorMsg, 'å®Œæ•´éŸ¿æ‡‰ï¼š', JSON.stringify(res, null, 2));
                mui.toast(errorMsg);
            }
        });
    }
    // ä¸Šå‚³åœ–ç‰‡ å‰µå»ºç¾¤
    function uploadthis(dom) {
        // ç¢ºèªæ˜¯å¦æœ‰ç”¨æˆ¶ID
        const currentUserId = userId();
        if (!currentUserId) {
            console.error('ä¸Šå‚³ç¾¤é ­åƒå¤±æ•—ï¼šæœªç™»å…¥æˆ–ç„¡æ³•ç²å–ç”¨æˆ¶ID');
            alert('è«‹å…ˆç™»å…¥å¾Œå†ä¸Šå‚³ç¾¤é ­åƒ');
            return;
        }
        
        console.log('ä¸Šå‚³ç¾¤é ­åƒï¼Œæ“æœ‰è€…ID:', currentUserId);
        
        // ä½¿ç”¨ä¿®æ”¹å¾Œçš„ uploadfile å‡½æ•¸ï¼Œå‚³å…¥æ­£ç¢ºçš„åƒæ•¸
        uploadfile("attach/upload", dom, function (res) {
            console.log('ç¾¤é ­åƒä¸Šå‚³éŸ¿æ‡‰ï¼š', res);
            // æª¢æŸ¥éŸ¿æ‡‰æ ¼å¼ï¼Œæ”¯æŒå…©ç¨®æˆåŠŸç‹€æ…‹ï¼šCode=0 æˆ– code=200
            if (res.Code == 0 || res.code == 200) {
                // ç¢ºå®šå›æ‡‰æ•¸æ“šä½ç½®
                const responseData = res.Data || res.data || {};
                // ç²å–æ–‡ä»¶URL
                const fileUrl = typeof responseData === 'string' ? responseData : (responseData.file_url || '');
                
                if (!fileUrl) {
                    console.error('ç¾¤é ­åƒURLç‚ºç©º');
                    alert('ç¾¤é ­åƒä¸Šå‚³å¤±æ•—ï¼šç„¡æ³•ç²å–URL');
                    return;
                }
                
                console.log('ç¾¤é ­åƒä¸Šå‚³æˆåŠŸï¼ŒURLï¼š', fileUrl);
                
                // æ›´æ–°ç¾¤é ­åƒ
                app.com.icon = fileUrl;
                
                // æ›´æ–°é é¢ä¸Šçš„ç¾¤é ­åƒå…ƒç´ 
                const iconElement = document.getElementById('icon');
                if (iconElement) {
                    iconElement.src = fileUrl;
                }
                
                console.log('ç¾¤é ­åƒæ›´æ–°æˆåŠŸï¼š', fileUrl);
                // é€šçŸ¥ç”¨æˆ¶
                mui.toast('ç¾¤é ­åƒä¸Šå‚³æˆåŠŸ');
            } else {
                const errorMsg = res.message || res.Msg || 'æœªçŸ¥éŒ¯èª¤';
                console.error('ç¾¤é ­åƒä¸Šå‚³å¤±æ•—ï¼š', errorMsg, res);
                alert('ç¾¤é ­åƒä¸Šå‚³å¤±æ•—ï¼š' + errorMsg);
            }
        });
    }
    // ç¶­è­·ç”¨æˆ¶é ­åƒ
    function uploadUserInfo(dom) {
        // ç¢ºèªæ˜¯å¦æœ‰ç”¨æˆ¶ID
        const currentUserId = userId();
        if (!currentUserId) {
            console.error('ä¸Šå‚³é ­åƒå¤±æ•—ï¼šæœªç™»å…¥æˆ–ç„¡æ³•ç²å–ç”¨æˆ¶ID');
            alert('è«‹å…ˆç™»å…¥å¾Œå†ä¸Šå‚³é ­åƒ');
            return;
        }
        
        console.log('ä¸Šå‚³é ­åƒï¼Œç”¨æˆ¶ID:', currentUserId);
        
        uploadfile("attach/upload", dom, function (res) {
            console.log('é ­åƒä¸Šå‚³éŸ¿æ‡‰ï¼š', res);
            // æª¢æŸ¥éŸ¿æ‡‰æ ¼å¼ï¼Œæ”¯æŒå…©ç¨®æˆåŠŸç‹€æ…‹ï¼šCode=0 æˆ– code=200
            if (res.Code == 0 || res.code == 200) {
                // ç¢ºå®šå›æ‡‰æ•¸æ“šä½ç½®
                const responseData = res.Data || res.data || {};
                // ç²å–æ–‡ä»¶URL
                const fileUrl = typeof responseData === 'string' ? responseData : (responseData.file_url || '');
                
                if (!fileUrl) {
                    console.error('é ­åƒURLç‚ºç©º');
                    alert('é ­åƒä¸Šå‚³å¤±æ•—ï¼šç„¡æ³•ç²å–URL');
                    return;
                }
                
                console.log('é ­åƒä¸Šå‚³æˆåŠŸï¼ŒURLï¼š', fileUrl);
                
                // æ›´æ–°æ‰€æœ‰ç›¸é—œçš„é ­åƒé¡¯ç¤º
                app.info.icon = fileUrl;
                app.profile.avatar = fileUrl;
                
                // æ›´æ–° sessionStorage ä¸­çš„ç”¨æˆ¶ä¿¡æ¯
                let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                userInfo.Avatar = fileUrl;
                sessionStorage.setItem('userinfo', JSON.stringify(userInfo));
                
                // æ›´æ–°é é¢ä¸Šçš„æ‰€æœ‰é ­åƒå…ƒç´ 
                const avatarElements = document.querySelectorAll('img[src*="avatar"]');
                avatarElements.forEach(element => {
                    if (element.id === 'userAvatar' || element.classList.contains('avatar')) {
                        element.src = fileUrl;
                    }
                });
                
                console.log('é ­åƒæ›´æ–°æˆåŠŸï¼š', fileUrl);
                // é€šçŸ¥ç”¨æˆ¶
                mui.toast('é ­åƒæ›´æ–°æˆåŠŸ');
            } else {
                const errorMsg = res.message || res.Msg || 'æœªçŸ¥éŒ¯èª¤';
                console.error('é ­åƒä¸Šå‚³å¤±æ•—ï¼š', errorMsg, res);
                alert('é ­åƒä¸Šå‚³å¤±æ•—ï¼š' + errorMsg);
            }
        });
    }



    function userId() {
        const id = parseInt(util.parseQuery("userId"));
        console.log('ğŸ¯ ç”¨æˆ¶idï¼š', id);
        return id;
    }
    var app = new Vue(
        {
            el: "#pageapp",
            data: {
                usermap: {},
                friends: [],
                communitys: [],
                profile: {
                    avatar: "",
                    nickname: "",
                    memo: "",
                },
                webSocket: null,
                win: "main",
                com: {
                    "ownerId": "",
                    "icon": "",
                    "cate": "",
                    "name": "",
                    "memo": "",
                    "size": "0",
                    "joinType": "0"
                },
                //ç”¨æˆ·ä¿¡æ¯
                info: {
                    "id": "",
                    "icon": "",
                    "name": "",
                },
                isDisable: true,
                isLoadMore: false,
                start: 0,
                end: 9,
                txtmsg: "",
                panelstat: "kbord",
                txtstat: "kbord",
                title: "",
                otherAvatar: '',
                doutu: {
                    config: {
                        "baseurl": "web/asset/plugins/doutu",
                        "pkgids": ["mkgif", "emoj"]
                    },
                    packages: [],
                    choosed: { "pkgid": "emoj", "assets": [], "size": "small" }
                },
                msglist: [],
                isReadRedisMsg: [],  //æ˜¯å¦å·²è¯»å–æŸä¸ªç”¨æˆ·çš„ç¼“å­˜æ¶ˆæ¯
                msgcontext: {
                    TargetId: -1,
                    Type: -1,
                    CreateTime: new Date().getTime(),
                    userId: userId()
                },
                plugins: [
                    {
                        icon: "icon-tupian",
                        name: "ç…§ç‰‡",
                        id: "upload",
                        slot: "<input accept=\"image/gif,image/jpeg,image/png\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },
                    {
                        icon: "icon-paizhao",
                        name: "æ‹ç…§",
                        id: "camera",
                        slot: "<input accept=\"image/*\" capture=\"camera\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },
                    {
                        icon: "icon-emoji",
                        name: "è¡¨æƒ…",
                        id: "emoji",
                        slot: "<div onclick=\"showEmojiPicker()\" class='emoji-btn'></div>"
                    },
                    {
                        icon: "icon-yuyin",
                        name: "èªéŸ³",
                        id: "audiocall"
                    },
                    {
                        icon: "icon-shipin",
                        name: "è¦–é »",
                        id: "videocall"
                    },
                    {
                        icon: "icon-hongbao",
                        name: "ç´…åŒ…",
                        id: "redpackage"
                    },
                    {
                        icon: "icon-zhuanzhang",
                        name: "è½‰å¸³",
                        id: "exchange"
                    },
                    {
                        icon: "icon-daohangdizhi",
                        name: "åœ°å€",
                        id: "address"
                    },
                    {
                        icon: "icon-zhanghu",
                        name: "åç‰‡",
                        id: "person"
                    }
                ],
                timer: 0,
                recorder: {},
                allChunks: [],
                iscomplete: false,
                duration: 0,
                showprocess: false,
                reconnectAttempts: 0,
                maxReconnectAttempts: 5,
                messageQueue: [],
                isConnecting: false,
                processedMessages: {},
                isSending: false,  // æ·»åŠ ç™¼é€ç‹€æ…‹æ¨™è¨˜
            },
            created: function () {
                this.loadfriends();
                this.loadcommunitys();
                this.loaddoutures();
                setInterval(this.heartbeat, 10 * 1000);
                var user = userInfo()
                // åˆå§‹åŒ– websocket
                this.initwebsocket()
                this.initUser();

            },
            mounted: function () {

            },
            methods: {
                handleAvatarError(e) {
                    console.warn('é ­åƒè¼‰å…¥å¤±æ•¸ï¼Œä½¿ç”¨é è¨­é ­åƒ');
                    e.target.src = '/web/asset/images/avatar0.png';
                },
                initUser() {
                    let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                    // ç¢ºä¿é ­åƒ URL æ­£ç¢º
                    let avatarUrl = userInfo.Avatar;
                    if (avatarUrl && !avatarUrl.startsWith('http') && !avatarUrl.startsWith('/')) {
                        avatarUrl = '/web/asset/images/' + avatarUrl;
                    }
                    
                    this.info.icon = avatarUrl;
                    this.info.name = userInfo.Name;
                    this.info.id = userInfo.ID;
                    this.profile.avatar = avatarUrl;
                    this.profile.nickname = userInfo.Name;
                    
                    console.log('åˆå§‹åŒ–ç”¨æˆ¶ä¿¡æ¯ï¼š', {
                        icon: this.info.icon,
                        avatar: this.profile.avatar,
                        name: this.info.name
                    });
                },
                playaudio: function (url) {
                    document.getElementById('audio4play').src = url;
                    document.getElementById('audio4play').play();
                },
                startrecorder: function () {
                    let audioTarget = document.getElementById('audio');
                    var types = ["video/webm",
                        "audio/webm",
                        "video/webm\;codecs=vp8",
                        "video/webm\;codecs=daala",
                        "video/webm\;codecs=h264",
                        "audio/webm\;codecs=opus",
                        "video/mpeg"];
                    var suporttype = "";
                    for (var i in types) {
                        if (MediaRecorder.isTypeSupported(types[i])) {
                            suporttype = types[i];
                        }
                    }
                    if (!suporttype) {
                        mui.toast("ç·¨ç¢¼ä¸æ”¯æŒ")
                        return;
                    }

                    this.duration = new Date().getTime();
                    //video æ”åƒé ­   ï¼Œaudio éŸ³é »
                    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                        .then(function (stream) {
                            this.showprocess = true
                            this.recorder = new MediaRecorder(stream);
                            audioTarget.srcObject = stream;
                            // æ˜¯å¦å¯ç”¨
                            this.recorder.ondataavailable = (event) => {
                                console.log("ondataavailable");
                                uploadblob("attach/upload", event.data, ".mp3", res => {
                                    var duration = Math.ceil((new Date().getTime() - this.duration) / 1000);
                                    this.sendaudiomsg(res.Data, duration);
                                })
                                stream.getTracks().forEach(function (track) {
                                    track.stop();
                                });
                                this.showprocess = false
                            }
                            this.recorder.start();
                        }.bind(this)).
                        catch(function (err) {
                            console.log(err)
                            mui.toast(err)
                            this.showprocess = false
                        }.bind(this));
                },
                stoprecorder: function () {
                    if (typeof this.recorder.stop == "function") {
                        this.recorder.stop();
                    }
                    this.showprocess = false
                    console.log("stoprecorder")

                },
                dispatchplugin: function (item) {
                    switch (item.id) {
                        case "upload":
                        case "camera":

                            break;
                        default:
                            mui.toast("ç³»çµ±æš«ä¸æ”¯æŒï¼Œè«‹è‡ªè¡Œæ“´å±•")
                    }
                },
                reset: function () {
                    this.panelstat = "kbord";
                    this.txtstat = "kbord";
                    this.txtmsg = "";
                },
                createmsgcontext: function () {
                    return {
                        TargetId: this.msgcontext.TargetId,
                        Type: this.msgcontext.Type,
                        CreateTime: new Date().getTime(),
                        userId: userId(),
                        Media: 1, // é»˜èªæ–‡å­—é¡å‹
                        Content: "",
                        Url: "",
                        Amount: 0
                    };
                },
                loaddoutures: function () {
                    var res = [];
                    var config = this.doutu.config;
                    for (var i in config.pkgids) {
                        res[config.pkgids[i]] = (config.baseurl + "/" + config.pkgids[i] + "/info.json")
                    }
                    var that = this;
                    for (var id in res) {
                        this.$http.get(res[id]).then(response => {
                            pkginfo = response.data
                            var baseurl = config.baseurl + "/" + pkginfo.id + "/"
                            // console.log("post res[i]",id,res[id],pkginfo)
                            for (var j in pkginfo.assets) {
                                pkginfo.assets[j] = baseurl + pkginfo.assets[j];
                            }
                            pkginfo.icon = baseurl + pkginfo.icon;
                            that.doutu.packages.push(pkginfo)
                            if (that.doutu.choosed.pkgid == pkginfo.id) {
                                that.doutu.choosed.assets = pkginfo.assets;
                            }

                        })
                    }
                },
                showweixin: function () {
                    mui.alert("è«‹åŠ å¾®ä¿¡è™Ÿxxxç´¢å–")
                },
                showmsg: function (user, msg, isReverse, isFirst) {
                    console.log('é¡¯ç¤ºæ¶ˆæ¯ï¼š', {
                        user: user,
                        msg: msg,
                        isReverse: isReverse,
                        isFirst: isFirst
                    });

                    var data = {
                        ismine: userId() == msg.userId,
                        user: user,
                        msg: msg
                    }
                    
                    if (isReverse) {
                        this.msglist = [data].concat(this.msglist);
                    } else {
                        if (isFirst) {
                            this.msglist = [data].concat(this.msglist);
                        } else {
                            this.msglist = this.msglist.concat(data)
                        }
                    }
                    
                    if (!isReverse) {
                        this.panelstat = "kbord";
                    }
                    
                    var that = this;
                    that.timer = setTimeout(function () {
                        window.scrollTo(0, document.getElementById("convo").offsetHeight);
                        if (!isReverse) {
                            let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                            let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                            let y = scroll - inner - 80;
                            let transform = document.querySelector("#convo .mui-scroll").style.transform;
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                        } else {
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + 0 + 'px)';
                        }
                        clearTimeout(that.timer)
                    }, 100)
                },
                startrecord: function () {

                },
                // è·Ÿèª°å–®èŠ
                sendtxtmsg: function (txt) {
                    if (!txt.trim()) return;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ç›®æ¨™ç”¨æˆ¶
                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡", this.msgcontext);
                        mui.toast("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡");
                        return;
                    }

                    console.log("ç™¼é€æ¶ˆæ¯ï¼Œä¸Šä¸‹æ–‡:", this.msgcontext);
                    
                    var msg = this.createmsgcontext();
                    msg.Content = txt;
                    msg.Media = 1; // æ–‡å­—é¡å‹
                    msg.TargetId = this.msgcontext.TargetId; // ç¢ºä¿è¨­ç½®ç›®æ¨™ID
                    msg.Type = this.msgcontext.Type; // ç¢ºä¿è¨­ç½®æ¶ˆæ¯é¡å‹
                    
                    console.log("æº–å‚™ç™¼é€çš„æ¶ˆæ¯:", msg);
                    
                    // å…ˆé¡¯ç¤ºæ¶ˆæ¯
                    this.showmsg(userInfo(), msg);
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    this.txtmsg = "";
                    
                    // ç™¼é€åˆ°æœå‹™å™¨
                    this.sendMessageToServer(msg);
                },
                sendpicmsg: function (url) {
                    if (this.isSending) {
                        return;
                    }
                    this.isSending = true;

                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡", this.msgcontext);
                        mui.toast("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡");
                        this.isSending = false;
                        return;
                    }

                    console.log('æº–å‚™ç™¼é€åœ–ç‰‡æ¶ˆæ¯ï¼š', {
                        url: url,
                        fullUrl: window.location.origin + url,
                        fileName: url.split('/').pop(),
                        targetId: this.msgcontext.TargetId,
                        type: this.msgcontext.Type
                    });

                    var msg = this.createmsgcontext();
                    msg.Url = url;
                    msg.Media = 4;
                    msg.TargetId = this.msgcontext.TargetId;
                    msg.Type = this.msgcontext.Type;
                    msg.id = new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    console.log('å‰µå»ºçš„æ¶ˆæ¯å°è±¡ï¼š', {
                        ...msg,
                        fullImageUrl: window.location.origin + msg.Url
                    });
                    
                    this.showmsg(userInfo(), msg);
                    
                    if (!this.processedMessages) {
                        this.processedMessages = {};
                    }
                    this.processedMessages[msg.id] = true;
                    
                    this.sendMessageToServer(msg);

                    setTimeout(() => {
                        this.isSending = false;
                    }, 1000);
                },
                sendaudiomsg: function (url, duration) {
                    var msg = this.createmsgcontext();
                    msg.Url = url;
                    msg.Media = 3; // èªéŸ³é¡å‹
                    msg.Amount = duration;
                    
                    // å…ˆé¡¯ç¤ºæ¶ˆæ¯
                    this.showmsg(userInfo(), msg);
                    
                    // ç™¼é€åˆ°æœå‹™å™¨
                    this.sendMessageToServer(msg);
                },
                scrollConcat() {
                    console.log(123)
                },
                closePanel() {
                    this.panelstat = 'kbord';
                },
                singlemsg: function (user) {
                    // æª¢æŸ¥ç”¨æˆ¶å°è±¡æ˜¯å¦æœ‰æ•ˆ
                    if (!user) {
                        console.error("ç”¨æˆ¶å°è±¡ç‚ºç©º");
                        mui.toast("ç„¡æ³•ç²å–ç”¨æˆ¶ä¿¡æ¯");
                        return;
                    }

                    // æª¢æŸ¥å¿…è¦çš„ç”¨æˆ¶å±¬æ€§
                    if (!user.ID && !user.id) {
                        console.error("ç”¨æˆ¶IDç„¡æ•ˆ:", user);
                        mui.toast("ç”¨æˆ¶IDç„¡æ•ˆ");
                        return;
                    }

                    // çµ±ä¸€ä½¿ç”¨ ID å±¬æ€§
                    const userId = user.ID || user.id;
                    const userName = user.name || user.Name;
                    const userAvatar = user.Avatar || user.avatar;

                    // ç¢ºä¿é ­åƒURLæ­£ç¢º
                    let avatarUrl = userAvatar;
                    if (avatarUrl && !avatarUrl.startsWith("http") && !avatarUrl.startsWith("/")) {
                        avatarUrl = "/web/asset/images/" + avatarUrl;
                    }

                    console.log("é–‹å§‹èŠå¤©ï¼Œç”¨æˆ¶ä¿¡æ¯:", {
                        id: userId,
                        name: userName,
                        avatar: avatarUrl
                    });
                    
                    if (this.isDisable) {
                        this.setTimeFlag();
                        this.win = "single";
                        this.title = "å’Œã€" + userName + "ã€‘èŠå¤©ä¸­";
                        this.otherAvatar = avatarUrl || "/web/asset/images/avatar0.png";
                        
                        // ç¢ºä¿æ­£ç¢ºè¨­ç½®ç›®æ¨™IDå’Œé¡å‹
                        const targetId = parseInt(userId);
                        if (isNaN(targetId)) {
                            console.error("ç”¨æˆ¶IDç„¡æ•ˆ:", userId);
                            mui.toast("ç”¨æˆ¶IDç„¡æ•ˆ");
                            return;
                        }
                        
                        // é‡ç½®æ¶ˆæ¯åˆ—è¡¨
                        this.msglist = [];
                        this.currentPage = 1;
                        
                        this.msgcontext.TargetId = targetId;
                        this.msgcontext.Type = 1; // ç§èŠé¡å‹
                        
                        console.log("è¨­ç½®èŠå¤©ä¸Šä¸‹æ–‡:", this.msgcontext);
                        
                        // åŠ è¼‰èŠå¤©æ­·å²
                        this.loadChatHistory(this.msgcontext.userId, this.msgcontext.TargetId);
                        
                        // ä½¿ç”¨ Vue çš„ nextTick ç¢ºä¿ DOM å·²æ›´æ–°
                        this.$nextTick(() => {
                            // è¨­ç½®æ»¾å‹•
                            const scrollWrapper = document.querySelector('.mui-scroll-wrapper');
                            if (scrollWrapper) {
                                mui(scrollWrapper).scroll({
                                    scrollY: true,
                                    scrollX: false,
                                    startX: 0,
                                    startY: 0,
                                    indicators: true,
                                    deceleration: 0.0006,
                                    bounce: true
                                });

                                // ç›£è½æ»¾å‹•äº‹ä»¶
                                const scrollElement = scrollWrapper.querySelector('.mui-scroll');
                                if (scrollElement) {
                                    scrollElement.addEventListener('scroll', (e) => {
                                        const target = e.currentTarget;
                                        if (!target || !target.style) {
                                            return;
                                        }

                                        const transform = target.style.transform;
                                        if (!transform) {
                                            return;
                                        }

                                        const translate = transform.match(/translate3d\(\d+px,\s*(\d+)px,\s*(\d+)px\)/i);
                                        if (translate && translate.length > 1) {
                                            const y = parseInt(translate[1]);
                                            if (y > 0 && this.isLoadMore == false) {
                                                this.isLoadMore = true;
                                                // åŠ è¼‰æ›´å¤šæ­·å²æ¶ˆæ¯
                                                this.loadMoreHistory(this.msgcontext.userId, this.msgcontext.TargetId);
                                                
                                                setTimeout(() => {
                                                    this.isLoadMore = false;
                                                }, 300);
                                            }
                                        }
                                    });
                                }
                            }
                        });
                    }
                },
                // ç¾¤èŠçš„åˆå§‹åŒ–
                groupmsg: function (group) {
                    if (this.isDisable) {
                        this.setTimeFlag()
                        this.win = "group";
                        this.title = group.name;
                        this.msgcontext.TargetId = parseInt(group.id);
                        this.msgcontext.Type = 2;
                    }
                },
                loaduserinfo: function (userid, cb) {
                    if (!userid) {
                        console.error("ç”¨æˆ¶IDç„¡æ•ˆ");
                        return;
                    }
                    
                    userid = "" + userid;
                    var userinfo = this.usermap[userid];
                    
                    if (!userinfo) {
                        // åªåœ¨é¦–æ¬¡åŠ è¼‰æ™‚è¼¸å‡ºæ—¥èªŒ
                        console.log("é¦–æ¬¡åŠ è¼‰ç”¨æˆ¶ä¿¡æ¯:", userid);
                        
                        fetch("/user/find", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({ userId: parseInt(userid) })
                        })
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(res => {
                            if (res.code === 0 && res.data) {
                                // ç¢ºä¿é ­åƒURLæ­£ç¢º
                                if (res.data.Avatar && !res.data.Avatar.startsWith("http")) {
                                    res.data.Avatar = "/web/asset/images/" + res.data.Avatar;
                                }
                                this.usermap[userid] = res.data;
                                cb(res.data);
                            } else {
                                console.error("ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:", res.message);
                                // ä½¿ç”¨é è¨­é ­åƒ
                                const defaultUser = {
                                    ID: parseInt(userid),
                                    Name: "æœªçŸ¥ç”¨æˆ¶",
                                    Avatar: "/web/asset/images/avatar0.png"
                                };
                                this.usermap[userid] = defaultUser;
                                cb(defaultUser);
                            }
                        })
                        .catch(err => {
                            console.error("åŠ è¼‰ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:", err);
                            // ä½¿ç”¨é è¨­é ­åƒ
                            const defaultUser = {
                                ID: parseInt(userid),
                                Name: "æœªçŸ¥ç”¨æˆ¶",
                                Avatar: "/web/asset/images/avatar0.png"
                            };
                            this.usermap[userid] = defaultUser;
                            cb(defaultUser);
                        });
                    } else {
                        // ä½¿ç”¨ç·©å­˜æ™‚ä¸è¼¸å‡ºæ—¥èªŒ
                        cb(userinfo);
                    }
                },
                onmessage: function (data) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºå¿ƒè·³æ¶ˆæ¯
                    if (data.Media === -1 && data.Type === 3) {
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†éé€™æ¢æ¶ˆæ¯
                    if (this.processedMessages && this.processedMessages[data.id]) {
                        return;
                    }

                    // æ¨™è¨˜æ¶ˆæ¯ç‚ºå·²è™•ç†
                    if (!this.processedMessages) {
                        this.processedMessages = {};
                    }
                    this.processedMessages[data.id] = true;

                    // å¦‚æœæ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›ï¼ˆå› ç‚ºå·²ç¶“åœ¨ç™¼é€æ™‚é¡¯ç¤ºéäº†ï¼‰
                    if (data.userId === userId()) {
                        return;
                    }

                    // è™•ç†å°æ–¹çš„æ¶ˆæ¯
                    this.loaduserinfo(data.userId, function (user) {
                        this.showmsg(user, data);
                        
                        // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„æœ€å¾Œä¸€æ¢æ¶ˆæ¯
                        this.friends.forEach((item) => {
                            if (item.ID == data.userId) {
                                // 1æ–‡å­— 2è¡¨æƒ…åŒ… 3åœ–ç‰‡ 4éŸ³é »
                                if (data.Media === 1) {
                                    item.memo = data.Content;
                                } else if (data.Media === 2) {
                                    item.memo = data.Url;
                                } else if (data.Media === 3) {
                                    item.memo = "[èªéŸ³]";
                                } else if (data.Media === 4) {
                                    item.memo = "[åœ–ç‰‡]";
                                }
                            }
                        });
                    }.bind(this));
                },
                initwebsocket: function () {
                    if (this.isConnecting) {
                        console.log("WebSocket æ­£åœ¨é€£æ¥ä¸­ï¼Œè·³éé‡é€£");
                        return;
                    }

                    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                        console.error("WebSocket é‡é€£æ¬¡æ•¸è¶…éé™åˆ¶ï¼Œåœæ­¢é‡é€£");
                        mui.toast("ç¶²çµ¡é€£æ¥å¤±æ•—ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦");
                        return;
                    }

                    this.isConnecting = true;
                    this.reconnectAttempts++;

                    try {
                        var protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                        var url = protocol + location.host + "/chat/ws?userId=" + userId() + "&token=" + util.parseQuery("token");
                        console.log("é€£æ¥ WebSocket:", url);
                        
                        this.webSocket = new WebSocket(url);
                        
                        this.webSocket.onmessage = function (evt) {
                            try {
                                if (evt.data.indexOf("}") > -1) {
                                    var data = JSON.parse(evt.data);
                                    this.onmessage(data);
                                }
                            } catch (error) {
                                console.error("WebSocket è¨Šæ¯è§£æéŒ¯èª¤:", error);
                            }
                        }.bind(this);
                        
                        this.webSocket.onclose = function (evt) {
                            console.log("WebSocket é€£æ¥å·²é—œé–‰ï¼Œå˜—è©¦é‡æ–°é€£æ¥...");
                            this.isConnecting = false;
                            setTimeout(this.initwebsocket.bind(this), 5000);
                        }.bind(this);
                        
                        this.webSocket.onerror = function (evt) {
                            console.error("WebSocket éŒ¯èª¤:", evt);
                            this.isConnecting = false;
                            setTimeout(this.initwebsocket.bind(this), 5000);
                        }.bind(this);
                        
                        this.webSocket.onopen = function (evt) {
                            console.log("WebSocket é€£æ¥æˆåŠŸ");
                            this.reconnectAttempts = 0;
                            this.isConnecting = false;
                            this.startHeartbeat();
                            // ç™¼é€éšŠåˆ—ä¸­çš„æ¶ˆæ¯
                            this.processMessageQueue();
                        }.bind(this);
                    } catch (error) {
                        console.error("WebSocket åˆå§‹åŒ–éŒ¯èª¤:", error);
                        this.isConnecting = false;
                        setTimeout(this.initwebsocket.bind(this), 5000);
                    }
                },
                processMessageQueue: function() {
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        while (this.messageQueue.length > 0) {
                            const msg = this.messageQueue.shift();
                            this.webSocket.send(JSON.stringify(msg));
                        }
                    }
                },
                sendMessageToServer: function (msg) {
                    if (!msg || !msg.TargetId || msg.TargetId <= 0) {
                        console.error("ç„¡æ•ˆçš„æ¶ˆæ¯æˆ–ç›®æ¨™ID:", msg);
                        return;
                    }

                    // ç”Ÿæˆæ¶ˆæ¯ID
                    msg.id = new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        this.webSocket.send(JSON.stringify(msg));
                    } else {
                        console.log("WebSocket æœªé€£æ¥ï¼Œæ¶ˆæ¯åŠ å…¥éšŠåˆ—");
                        this.messageQueue.push(msg);
                        if (!this.isConnecting) {
                            this.initwebsocket();
                        }
                    }
                },
                startHeartbeat: function () {
                    if (this.heartbeatTimer) {
                        clearInterval(this.heartbeatTimer);
                    }
                    
                    // æ¯ 60 ç§’ç™¼é€ä¸€æ¬¡å¿ƒè·³
                    this.heartbeatTimer = setInterval(() => {
                        if (this.webSocket && this.webSocket.readyState === 1) {
                            this.heartbeat();
                        }
                    }, 60000);
                },
                heartbeat() {
                    if (this.webSocket.readyState == 1) {  //å¤±å»è¿æ¥ 3
                        var msg = this.createmsgcontext();
                        msg.Media = -1;
                        msg.Type = 3
                        msg.Content = "å¿ƒè·³";
                        //this.showmsg(userInfo(),msg);
                        this.webSocket.send(JSON.stringify(msg))
                    }

                },
                loadChatHistory: function (userId, targetId, page = 1, size = 20) {
                    // é©—è­‰åƒæ•¸
                    if (!userId || !targetId) {
                        console.error("ç”¨æˆ¶IDæˆ–ç›®æ¨™IDä¸èƒ½ç‚ºç©º", { userId, targetId });
                        mui.toast("ç„¡æ³•åŠ è¼‰èŠå¤©æ­·å²");
                        return;
                    }

                    console.log("é–‹å§‹åŠ è¼‰èŠå¤©æ­·å²:", { 
                        userId, 
                        targetId, 
                        page, 
                        size,
                        token: util.parseQuery("token")
                    });

                    // é¡¯ç¤ºåŠ è¼‰æç¤º
                    mui.toast("åŠ è¼‰ä¸­...", { duration: 'short' });

                    const url = `/chat/private/history?userId=${userId}&targetId=${targetId}&page=${page}&size=${size}`;
                    console.log("è«‹æ±‚URL:", url);

                    fetch(url, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        }
                    })
                    .then(response => {
                        console.log("æ”¶åˆ°éŸ¿æ‡‰:", {
                            status: response.status,
                            statusText: response.statusText,
                            headers: Object.fromEntries(response.headers.entries())
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        console.log("éŸ¿æ‡‰æ–‡æœ¬:", text);
                        try {
                            // æª¢æŸ¥æ˜¯å¦ç‚ºç©ºéŸ¿æ‡‰
                            if (!text || text.trim() === '') {
                                console.log("æ”¶åˆ°ç©ºéŸ¿æ‡‰ï¼Œå¯èƒ½æ˜¯æ²’æœ‰èŠå¤©è¨˜éŒ„");
                                return { code: 0, data: [] };
                            }
                            const data = JSON.parse(text);
                            console.log("è§£æå¾Œçš„æ•¸æ“š:", data);
                            return data;
                        } catch (e) {
                            console.error("è§£æéŸ¿æ‡‰å¤±æ•—:", e, "åŸå§‹æ–‡æœ¬:", text);
                            throw new Error("ç„¡æ•ˆçš„éŸ¿æ‡‰æ ¼å¼");
                        }
                    })
                    .then(res => {
                        console.log("è™•ç†éŸ¿æ‡‰æ•¸æ“š:", res);
                        
                        // æª¢æŸ¥éŸ¿æ‡‰æ ¼å¼
                        if (!res || typeof res !== 'object') {
                            console.warn("ç„¡æ•ˆçš„éŸ¿æ‡‰æ ¼å¼");
                            mui.toast("ç„¡æ•ˆçš„éŸ¿æ‡‰æ ¼å¼");
                            return;
                        }

                        // è™•ç†æˆåŠŸéŸ¿æ‡‰
                        if (res.code === 0) {
                            const messages = res.data || [];
                            if (Array.isArray(messages)) {
                                console.log("é–‹å§‹è™•ç†æ¶ˆæ¯åˆ—è¡¨:", messages.length);
                                
                                if (messages.length === 0) {
                                    console.log("æ²’æœ‰èŠå¤©è¨˜éŒ„");
                                    mui.toast("æš«ç„¡èŠå¤©è¨˜éŒ„");
                                    return;
                                }

                                messages.forEach((msg, index) => {
                                    console.log(`è™•ç†ç¬¬ ${index + 1} æ¢æ¶ˆæ¯:`, msg);
                                    // åˆ¤æ–·æ¶ˆæ¯ç™¼é€è€…
                                    if (msg.userId == userId) {
                                        // è‡ªå·±ç™¼é€çš„æ¶ˆæ¯
                                        this.showmsg(userInfo(), msg, true);
                                    } else {
                                        // å°æ–¹ç™¼é€çš„æ¶ˆæ¯
                                        this.loaduserinfo(msg.userId, user => {
                                            this.showmsg(user, msg, true);
                                        });
                                    }
                                });
                                console.log("æ¶ˆæ¯è™•ç†å®Œæˆ");
                            } else {
                                console.warn("èŠå¤©æ­·å²æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º:", messages);
                                mui.toast("èŠå¤©æ­·å²æ ¼å¼éŒ¯èª¤");
                            }
                        } else {
                            const errorMsg = res.message || res.msg || "æœªçŸ¥éŒ¯èª¤";
                            console.error("åŠ è¼‰èŠå¤©æ­·å²å¤±æ•—:", {
                                code: res.code,
                                message: errorMsg,
                                data: res.data
                            });
                            mui.toast(errorMsg);
                        }
                    })
                    .catch(err => {
                        console.error("åŠ è¼‰èŠå¤©æ­·å²å¤±æ•—:", err);
                        mui.toast("åŠ è¼‰èŠå¤©æ­·å²å¤±æ•—: " + err.message);
                    });
                },
                loadMoreHistory: function (userId, targetId) {
                    this.currentPage = this.currentPage || 1;
                    this.currentPage++;
                    this.loadChatHistory(userId, targetId, this.currentPage);
                },
                loadfriends: function () {
                    fetch("/user/searchFriends", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        },
                        body: JSON.stringify({
                            userId: userId()
                        })
                    })
                        .then(response => response.json())
                        .then(res => {
                        if (res.code === 0) {
                            this.friends = res.rows || [];
                            let usermap = {};
                            for (let i in this.friends) {
                                const k = "" + this.friends[i].id;
                                usermap[k] = this.friends[i];
                            }
                            console.log("å¥½å‹åˆ—è¡¨åŠ è¼‰å®Œæˆ:", this.friends);
                            console.log("ç”¨æˆ¶æ˜ å°„:", usermap);
                            this.usermap = usermap;
                        } else {
                            console.error("åŠ è¼‰å¥½å‹åˆ—è¡¨å¤±æ•—:", res.message);
                        }
                        })
                        .catch(err => {
                        console.error("åŠ è¼‰å¥½å‹åˆ—è¡¨è«‹æ±‚å¤±æ•—:", err);
                        });
                },
                loadcommunitys: function () {
                    fetch(`/contact/groups?userId=${userId()}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        }
                    })
                    .then(response => response.json())
                    .then(res => {
                        if (res.code === 0) {
                            this.communitys = res.data || [];
                        } else {
                            console.error("åŠ è¼‰ç¾¤çµ„åˆ—è¡¨å¤±æ•—:", res.message);
                        }
                    })
                    .catch(err => {
                        console.error("åŠ è¼‰ç¾¤çµ„åˆ—è¡¨è«‹æ±‚å¤±æ•—:", err);
                    });
                },
                addfriend: function () {
                    //console.log("addfriend....")
                    var that = this;
                    mui.prompt('', 'è«‹è¼¸å…¥å¥½å‹åç¨±', 'åŠ å¥½å‹', ['å–æ¶ˆ', 'ç¢ºèª'], function (e) {
                        if (e.index == 1) {
                            console.log('ğŸ¯ å¥½å‹åç¨±ï¼š', e.value);
                            // åˆ¤æ–·æ•¸å­—
                            //if (isNaN(e.value) || e.value <= 0) {
                            //    mui.toast('æ ¼å¼éŒ¯èª¤');
                            //} else {
                            //mui.toast(e.value);
                            that._addfriend(e.value)
                            //}
                        } else {
                            //mui.toast('æ‚¨å–æ¶ˆäº†å…¥åº«');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';

                },
                _addfriend: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        
                        fetch("/contact/addFriend", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({
                                userId: userId(),
                                targetId: parseInt(dstobj)
                            })
                        })
                            .then(response => response.json())
                            .then(res => {
                            if (res.code === 0) {
                                    mui.toast("æ·»åŠ æˆåŠŸ");
                                    that.loadfriends();
                                } else {
                                mui.toast(res.message || "æ·»åŠ å¤±æ•—");
                                }
                            })
                            .catch(err => {
                            console.error("æ·»åŠ å¥½å‹è«‹æ±‚å¤±æ•—:", err);
                            mui.toast("ç¶²çµ¡éŒ¯èª¤");
                            });
                    }
                },
                // å„äººè³‡æ–™ä¿®æ”¹é¡¯ç¤º
                setUserInfo: function () {
                    this.win = "userinfo"
                    //  console.log("createCom")
                },
                // æ–°å»ºç¾¤é¡¯ç¤º
                createCom: function () {
                    this.win = "community"
                    // åˆå§‹åŒ–ç¾¤èŠæ•¸æ“š
                    this.com = {
                        ownerId: userId(),
                        icon: "",
                        cate: "0",
                        name: "",
                        memo: "",
                        size: "0",
                        joinType: "0"
                    }
                },

                // æ–°å»ºç¾¤æäº¤
                createcommunity: function () {
                    // é©—è­‰è¡¨å–®
                    if (!this.com.name || this.com.name.length < 2 || this.com.name.length > 20) {
                        mui.toast("ç¾¤åç¨±é•·åº¦å¿…é ˆåœ¨2-20å€‹å­—ç¬¦ä¹‹é–“");
                        return;
                    }
                    
                    if (!this.com.memo || this.com.memo.length > 200) {
                        mui.toast("ç¾¤ä»‹ç´¹ä¸èƒ½è¶…é200å­—");
                        return;
                    }
                    
                    if (!this.com.icon) {
                        mui.toast("è«‹ä¸Šå‚³ç¾¤é ­åƒ");
                        return;
                    }

                    this.com.ownerId = userId();
                    
                    fetch("/contact/create-group", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        },
                        body: JSON.stringify(this.com)
                    })
                    .then(response => response.json())
                    .then(res => {
                        if (res.code === 0) {
                            mui.toast("å»ºç¾¤æˆåŠŸ");
                            this.loadcommunitys();
                            this.goBack(); // è¿”å›ä¸Šä¸€é 
                        } else {
                            mui.toast(res.message || "å»ºç¾¤å¤±æ•—");
                        }
                    })
                    .catch(err => {
                        console.error("å‰µå»ºç¾¤çµ„è«‹æ±‚å¤±æ•—:", err);
                        mui.toast("ç¶²çµ¡éŒ¯èª¤");
                    });
                },
                updateUserInfo() {
                    //console.log("createcommunity")
                    this.info.id = userId()
                    util.post("/user/updateUser", this.info).then(res => {
                        console.log(res)
                        let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                        userInfo.Avatar = this.info.icon;
                        userInfo.Name = this.info.name;
                        sessionStorage.setItem('userinfo', JSON.stringify(userInfo))
                        if (res.Code != 0) {
                            mui.toast(res.message)
                        } else {
                            //location.replace("localhost:8081")
                            //location.href = "/"
                            mui.toast("ä¿®æ”¹æˆåŠŸ")
                            //goBack()
                        }
                    })
                },



                //å›åˆ°èŠå¤©é¦–é¡µ
                goBack() {
                    this.win = "main"
                },

                _joincomunity: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        console.log(that);
                        fetch("/contact/joinGroup", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({
                                comId: dstobj,
                                userId: userId()
                            })
                        })
                        .then(response => response.json())
                        .then(res => {
                            if (res.code === 0) {
                                mui.toast("åŠ å…¥æˆåŠŸ");
                                that.loadcommunitys();
                            } else {
                                mui.toast(res.message || "åŠ å…¥å¤±æ•—");
                            }
                        })
                        .catch(err => {
                            console.error("åŠ å…¥ç¾¤çµ„è«‹æ±‚å¤±æ•—:", err);
                            mui.toast("ç¶²çµ¡éŒ¯èª¤");
                        });
                    }
                },
                joincom: function () {
                    var that = this;
                    mui.prompt('', 'è¯·è¾“å…¥ç¾¤å·æˆ–è€…ç¾¤åç§°', 'åŠ ç¾¤', ['å–æ¶ˆ', 'ç¡®è®¤'], function (e) {
                        if (e.index == 1) {
                            //    if (isNaN(e.value) || e.value <= 0) {
                            //       mui.toast('æ ¼å¼é”™è¯¯');
                            //   } else {
                            //mui.toast(e.value);
                            that._joincomunity(e.value)
                            // }
                        } else {
                            //mui.toast('æ‚¨å–æ¶ˆäº†å…¥åº“');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';
                },
                quit: function () {
                    sessionStorage.removeItem("userid")
                    sessionStorage.removeItem("userinfo")
                    location.href = "/"
                },
                setTimeFlag() {
                    this.isDisable = false;
                    setTimeout(() => {
                        this.isDisable = true;
                    }, 100)
                },
                // æ·»åŠ  emoji é¸æ“‡å™¨
                showEmojiPicker() {
                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è¡¨æƒ…é¸æ“‡å™¨
                    const existingPicker = document.querySelector('.emoji-picker');
                    if (existingPicker) {
                        document.body.removeChild(existingPicker);
                        return;
                    }

                    var emojiContainer = document.createElement('div');
                    emojiContainer.className = 'emoji-picker';
                    emojiContainer.style.position = 'absolute';
                    emojiContainer.style.bottom = '50px';
                    emojiContainer.style.left = '0';
                    emojiContainer.style.backgroundColor = '#fff';
                    emojiContainer.style.border = '1px solid #ccc';
                    emojiContainer.style.padding = '10px';
                    emojiContainer.style.zIndex = '1000';
                    emojiContainer.style.display = 'grid';
                    emojiContainer.style.gridTemplateColumns = 'repeat(8, 1fr)';
                    emojiContainer.style.gap = '5px';

                    // åŠ è¼‰ emoji åˆ—è¡¨
                    var emojis = [];
                    for (var i = 1; i <= 13; i++) {
                        emojis.push(i + '.gif');
                    }

                    // å‰µå»º emoji æŒ‰éˆ•
                    emojis.forEach(function(emoji) {
                        var emojiBtn = document.createElement('img');
                        emojiBtn.src = '/web/asset/plugins/doutu/emoj/' + emoji;
                        emojiBtn.style.width = '24px';
                        emojiBtn.style.height = '24px';
                        emojiBtn.style.cursor = 'pointer';
                        emojiBtn.onclick = function() {
                            app.sendpicmsg('/web/asset/plugins/doutu/emoj/' + emoji);
                            document.body.removeChild(emojiContainer);
                        };
                        emojiContainer.appendChild(emojiBtn);
                    });

                    // æ·»åŠ é—œé–‰æŒ‰éˆ•
                    var closeBtn = document.createElement('button');
                    closeBtn.textContent = 'é—œé–‰';
                    closeBtn.style.gridColumn = '1 / -1';
                    closeBtn.style.marginTop = '10px';
                    closeBtn.onclick = function() {
                        document.body.removeChild(emojiContainer);
                    };
                    emojiContainer.appendChild(closeBtn);

                    document.body.appendChild(emojiContainer);
                },
                // è™•ç†åœ–ç‰‡åŠ è¼‰éŒ¯èª¤
                handleImageError: function(e) {
                    console.error('åœ–ç‰‡åŠ è¼‰å¤±æ•—ï¼š', e.target.src);
                    e.target.src = '/web/asset/images/image-error.png';
                    mui.toast('åœ–ç‰‡åŠ è¼‰å¤±æ•—');
                },
                
                // é è¦½åœ–ç‰‡
                previewImage: function(url) {
                    // ç¢ºä¿ URL æ˜¯å®Œæ•´çš„
                    const fullUrl = url.startsWith('http') ? url : 
                                  url.startsWith('/') ? url : 
                                  '/' + url;
                    
                    // å‰µå»ºé è¦½å®¹å™¨
                    const previewContainer = document.createElement('div');
                    previewContainer.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 9999;
                    `;
                    
                    // å‰µå»ºåœ–ç‰‡å…ƒç´ 
                    const img = document.createElement('img');
                    img.src = fullUrl;
                    img.style.cssText = `
                        max-width: 90%;
                        max-height: 90%;
                        object-fit: contain;
                    `;
                    
                    // é»æ“Šé—œé–‰é è¦½
                    previewContainer.onclick = function() {
                        document.body.removeChild(previewContainer);
                    };
                    
                    previewContainer.appendChild(img);
                    document.body.appendChild(previewContainer);
                },
            },
            watch: {
                "win": function (n, o) {
                    // console.log("watch",o,n)
                    if (n != "main") {
                        document.getElementById("menubar").style.display = "none";
                    } else {
                        document.getElementById("menubar").style.display = "block";
                    }
                }
            }
        }
    )

</script>
{{end}}