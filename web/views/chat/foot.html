{{define "chat/foot.html"}}
<script>

    function upload(dom) {
        if (!dom.files || !dom.files[0]) {
            mui.toast('è«‹é¸æ“‡åœ–ç‰‡');
            return;
        }

        const file = dom.files[0];
        console.log('æº–å‚™ä¸Šå‚³çš„æ–‡ä»¶ï¼š', {
            name: file.name,
            type: file.type,
            size: file.size
        });

        const validTypes = ['image/gif', 'image/jpeg', 'image/png'];
        if (!validTypes.includes(file.type)) {
            mui.toast('åªæ”¯æŒ GIFã€JPEGã€PNG æ ¼å¼çš„åœ–ç‰‡');
            return;
        }

        if (file.size > 5 * 1024 * 1024) {
            mui.toast('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
            return;
        }

        app.panelstat = 'kbord';

        uploadfile("attach/upload", dom, function (res) {
            console.log('ä¸Šå‚³éŸ¿æ‡‰å®Œæ•´æ•¸æ“šï¼š', JSON.stringify(res, null, 2));
            if (res.Code == 0 || res.code == 200) {
                if (!app.isSending) {
                    app.isSending = true;
                    // æ­£ç¢ºç²å–åœ–ç‰‡ URL
                    const imageUrl = res.data && res.data.file_url ? res.data.file_url : 
                                   res.Data && res.Data.file_url ? res.Data.file_url : null;
                    
                    if (!imageUrl) {
                        console.error('ç„¡æ³•ç²å–åœ–ç‰‡URLï¼Œå®Œæ•´éŸ¿æ‡‰ï¼š', JSON.stringify(res, null, 2));
                        mui.toast('ä¸Šå‚³å¤±æ•—ï¼šç„¡æ³•ç²å–åœ–ç‰‡URL');
                        app.isSending = false;
                        return;
                    }
                    
                    console.log('åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼Œå®Œæ•´è·¯å¾‘ï¼š', {
                        originalUrl: imageUrl,
                        fullUrl: window.location.origin + imageUrl,
                        fileName: imageUrl.split('/').pop()
                    });
                    
                    // ç›´æ¥æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å­˜åœ¨
                    const checkImg = new Image();
                    checkImg.onload = function() {
                        console.log('åœ–ç‰‡æ–‡ä»¶é©—è­‰æˆåŠŸï¼š', imageUrl);
                        // æ·»åŠ ç·Šæ€¥æ¨¡å¼ï¼šç›´æ¥é¡¯ç¤ºåœ–ç‰‡
                        app.emergencyDisplayImage(imageUrl);
                        app.sendpicmsg(imageUrl);
                    };
                    checkImg.onerror = function() {
                        console.error('åœ–ç‰‡æ–‡ä»¶ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•ï¼š', imageUrl);
                        mui.toast('åœ–ç‰‡æ–‡ä»¶ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•');
                    };
                    checkImg.src = imageUrl;
                    
                    setTimeout(() => {
                        app.isSending = false;
                    }, 1000);
                }
            } else {
                const errorMsg = res.message || res.Msg || 'ä¸Šå‚³å¤±æ•—';
                console.error('ä¸Šå‚³å¤±æ•—ï¼š', errorMsg, 'å®Œæ•´éŸ¿æ‡‰ï¼š', JSON.stringify(res, null, 2));
                mui.toast(errorMsg);
            }
        });
    }
    // ä¸Šå‚³åœ–ç‰‡ å‰µå»ºç¾¤
    function uploadthis(dom) {
        // ç¢ºèªæ˜¯å¦æœ‰ç”¨æˆ¶ID
        const currentUserId = userId();
        if (!currentUserId) {
            console.error('ä¸Šå‚³ç¾¤é ­åƒå¤±æ•—ï¼šæœªç™»å…¥æˆ–ç„¡æ³•ç²å–ç”¨æˆ¶ID');
            alert('è«‹å…ˆç™»å…¥å¾Œå†ä¸Šå‚³ç¾¤é ­åƒ');
            return;
        }
        
        console.log('ä¸Šå‚³ç¾¤é ­åƒï¼Œæ“æœ‰è€…ID:', currentUserId);
        
        // ä½¿ç”¨ä¿®æ”¹å¾Œçš„ uploadfile å‡½æ•¸ï¼Œå‚³å…¥æ­£ç¢ºçš„åƒæ•¸
        uploadfile("attach/upload", dom, function (res) {
            console.log('ç¾¤é ­åƒä¸Šå‚³éŸ¿æ‡‰ï¼š', res);
            // æª¢æŸ¥éŸ¿æ‡‰æ ¼å¼ï¼Œæ”¯æŒå…©ç¨®æˆåŠŸç‹€æ…‹ï¼šCode=0 æˆ– code=200
            if (res.Code == 0 || res.code == 200) {
                // ç¢ºå®šå›æ‡‰æ•¸æ“šä½ç½®
                const responseData = res.Data || res.data || {};
                // ç²å–æ–‡ä»¶URL
                const fileUrl = typeof responseData === 'string' ? responseData : (responseData.file_url || '');
                
                if (!fileUrl) {
                    console.error('ç¾¤é ­åƒURLç‚ºç©º');
                    alert('ç¾¤é ­åƒä¸Šå‚³å¤±æ•—ï¼šç„¡æ³•ç²å–URL');
                    return;
                }
                
                console.log('ç¾¤é ­åƒä¸Šå‚³æˆåŠŸï¼ŒURLï¼š', fileUrl);
                
                // æ›´æ–°ç¾¤é ­åƒ
                app.com.icon = fileUrl;
                
                // æ›´æ–°é é¢ä¸Šçš„ç¾¤é ­åƒå…ƒç´ 
                const iconElement = document.getElementById('icon');
                if (iconElement) {
                    iconElement.src = fileUrl;
                }
                
                console.log('ç¾¤é ­åƒæ›´æ–°æˆåŠŸï¼š', fileUrl);
                // é€šçŸ¥ç”¨æˆ¶
                mui.toast('ç¾¤é ­åƒä¸Šå‚³æˆåŠŸ');
            } else {
                const errorMsg = res.message || res.Msg || 'æœªçŸ¥éŒ¯èª¤';
                console.error('ç¾¤é ­åƒä¸Šå‚³å¤±æ•—ï¼š', errorMsg, res);
                alert('ç¾¤é ­åƒä¸Šå‚³å¤±æ•—ï¼š' + errorMsg);
            }
        });
    }
    // ç¶­è­·ç”¨æˆ¶é ­åƒ
    function uploadUserInfo(dom) {
        // ç¢ºèªæ˜¯å¦æœ‰ç”¨æˆ¶ID
        const currentUserId = userId();
        if (!currentUserId) {
            console.error('ä¸Šå‚³é ­åƒå¤±æ•—ï¼šæœªç™»å…¥æˆ–ç„¡æ³•ç²å–ç”¨æˆ¶ID');
            alert('è«‹å…ˆç™»å…¥å¾Œå†ä¸Šå‚³é ­åƒ');
            return;
        }
        
        console.log('ä¸Šå‚³é ­åƒï¼Œç”¨æˆ¶ID:', currentUserId);
        
        uploadfile("attach/upload", dom, function (res) {
            console.log('é ­åƒä¸Šå‚³éŸ¿æ‡‰ï¼š', res);
            // æª¢æŸ¥éŸ¿æ‡‰æ ¼å¼ï¼Œæ”¯æŒå…©ç¨®æˆåŠŸç‹€æ…‹ï¼šCode=0 æˆ– code=200
            if (res.Code == 0 || res.code == 200) {
                // ç¢ºå®šå›æ‡‰æ•¸æ“šä½ç½®
                const responseData = res.Data || res.data || {};
                // ç²å–æ–‡ä»¶URL
                const fileUrl = typeof responseData === 'string' ? responseData : (responseData.file_url || '');
                
                if (!fileUrl) {
                    console.error('é ­åƒURLç‚ºç©º');
                    alert('é ­åƒä¸Šå‚³å¤±æ•—ï¼šç„¡æ³•ç²å–URL');
                    return;
                }
                
                console.log('é ­åƒä¸Šå‚³æˆåŠŸï¼ŒURLï¼š', fileUrl);
                
                // æ›´æ–°æ‰€æœ‰ç›¸é—œçš„é ­åƒé¡¯ç¤º
                app.info.icon = fileUrl;
                app.profile.avatar = fileUrl;
                
                // æ›´æ–° sessionStorage ä¸­çš„ç”¨æˆ¶ä¿¡æ¯
                let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                userInfo.Avatar = fileUrl;
                sessionStorage.setItem('userinfo', JSON.stringify(userInfo));
                
                // æ›´æ–°é é¢ä¸Šçš„æ‰€æœ‰é ­åƒå…ƒç´ 
                const avatarElements = document.querySelectorAll('img[src*="avatar"]');
                avatarElements.forEach(element => {
                    if (element.id === 'userAvatar' || element.classList.contains('avatar')) {
                        element.src = fileUrl;
                    }
                });
                
                console.log('é ­åƒæ›´æ–°æˆåŠŸï¼š', fileUrl);
                // é€šçŸ¥ç”¨æˆ¶
                mui.toast('é ­åƒæ›´æ–°æˆåŠŸ');
            } else {
                const errorMsg = res.message || res.Msg || 'æœªçŸ¥éŒ¯èª¤';
                console.error('é ­åƒä¸Šå‚³å¤±æ•—ï¼š', errorMsg, res);
                alert('é ­åƒä¸Šå‚³å¤±æ•—ï¼š' + errorMsg);
            }
        });
    }



    function userId() {
        const id = parseInt(util.parseQuery("userId"));
        console.log('ğŸ¯ ç”¨æˆ¶idï¼š', id);
        return id;
    }
    var app = new Vue(
        {
            el: "#pageapp",
            data: {
                usermap: {},
                friends: [],
                communitys: [],
                profile: {
                    avatar: "",
                    nickname: "",
                    memo: "",
                },
                webSocket: null,
                win: "main",
                com: {
                    "ownerId": "",
                    "icon": "",
                    "cate": "",
                    "name": "",
                    "memo": "",
                    "size": "0",
                    "joinType": "0"
                },
                //ç”¨æˆ·ä¿¡æ¯
                info: {
                    "id": "",
                    "icon": "",
                    "name": "",
                },
                isDisable: true,
                isLoadMore: false,
                start: 0,
                end: 9,
                txtmsg: "",
                panelstat: "kbord",
                txtstat: "kbord",
                title: "",
                otherAvatar: '',
                doutu: {
                    config: {
                        "baseurl": "web/asset/plugins/doutu",
                        "pkgids": ["mkgif", "emoj"]
                    },
                    packages: [],
                    choosed: { "pkgid": "emoj", "assets": [], "size": "small" }
                },
                msglist: [],
                isReadRedisMsg: [],  //æ˜¯å¦å·²è¯»å–æŸä¸ªç”¨æˆ·çš„ç¼“å­˜æ¶ˆæ¯
                msgcontext: {
                    TargetId: -1,
                    Type: -1,
                    CreateTime: new Date().getTime(),
                    userId: userId()
                },
                plugins: [
                    {
                        icon: "icon-tupian",
                        name: "ç…§ç‰‡",
                        id: "upload",
                        slot: "<input accept=\"image/gif,image/jpeg,image/png\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },
                    {
                        icon: "icon-paizhao",
                        name: "æ‹ç…§",
                        id: "camera",
                        slot: "<input accept=\"image/*\" capture=\"camera\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },
                    {
                        icon: "icon-emoji",
                        name: "è¡¨æƒ…",
                        id: "emoji",
                        slot: "<div onclick=\"showEmojiPicker()\" class='emoji-btn'></div>"
                    },
                    {
                        icon: "icon-yuyin",
                        name: "èªéŸ³",
                        id: "audiocall"
                    },
                    {
                        icon: "icon-shipin",
                        name: "è¦–é »",
                        id: "videocall"
                    },
                    {
                        icon: "icon-hongbao",
                        name: "ç´…åŒ…",
                        id: "redpackage"
                    },
                    {
                        icon: "icon-zhuanzhang",
                        name: "è½‰å¸³",
                        id: "exchange"
                    },
                    {
                        icon: "icon-daohangdizhi",
                        name: "åœ°å€",
                        id: "address"
                    },
                    {
                        icon: "icon-zhanghu",
                        name: "åç‰‡",
                        id: "person"
                    }
                ],
                timer: 0,
                recorder: {},
                allChunks: [],
                iscomplete: false,
                duration: 0,
                showprocess: false,
                reconnectAttempts: 0,
                maxReconnectAttempts: 5,
                messageQueue: [],
                isConnecting: false,
                processedMessages: {},
                isSending: false,  // æ·»åŠ ç™¼é€ç‹€æ…‹æ¨™è¨˜
                currentPage: 1,
                isLoadingHistory: false,
                hasMoreHistory: true,
                lastScrollPosition: 0,
                scrollThreshold: 100, // æ–°å¢ï¼šæ»¾å‹•é–¾å€¼
                debounceTimer: null, // æ–°å¢ï¼šé˜²æŠ–å‹•è¨ˆæ™‚å™¨
                loadingIndicator: false, // æ–°å¢ï¼šè¼‰å…¥æŒ‡ç¤ºå™¨ç‹€æ…‹
                imageLoaded: true, // è¨­ç½®ç‚º true é˜²æ­¢åˆå§‹åŠ è¼‰æŒ‡ç¤ºå™¨é¡¯ç¤º
            },
            created: function () {
                this.loadfriends();
                this.loadcommunitys();
                this.loaddoutures();
                setInterval(this.heartbeat, 10 * 1000);
                var user = userInfo()
                // åˆå§‹åŒ– websocket
                this.initWebSocket()
                this.initUser();

                // è¨­ç½®å…¨å±€åœ–ç‰‡è™•ç†å™¨ï¼Œæ–¹ä¾¿èª¿è©¦
                window.addEventListener('error', (event) => {
                    if (event.target.tagName === 'IMG') {
                        console.error('å…¨å±€åœ–ç‰‡è¼‰å…¥éŒ¯èª¤:', {
                            src: event.target.src,
                            message: event.message
                        });
                    }
                }, true);
            },
            mounted: function () {
                // æª¢æŸ¥æ‰€æœ‰åœ–ç‰‡çš„å¯è¨ªå•æ€§
                setTimeout(() => {
                    this.checkAllImages();
                }, 2000);
            },
            methods: {
                // æª¢æŸ¥æ‰€æœ‰åœ–ç‰‡
                checkAllImages: function() {
                    console.log('æª¢æŸ¥æ‰€æœ‰åœ–ç‰‡å…ƒç´ ');
                    const allImages = document.querySelectorAll('img.pic');
                    if (allImages.length === 0) {
                        console.log('æœªæ‰¾åˆ°ä»»ä½•åœ–ç‰‡å…ƒç´ ');
                        
                        // æª¢æŸ¥èŠå¤©å®¹å™¨
                        const chatThread = document.querySelector('.chat-thread');
                        if (!chatThread) {
                            console.error('æ‰¾ä¸åˆ°èŠå¤©å®¹å™¨ .chat-thread');
                            return;
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦æœ‰æ¶ˆæ¯é …ç›®
                        const chatItems = chatThread.querySelectorAll('li.chat');
                        console.log(`æ‰¾åˆ° ${chatItems.length} å€‹èŠå¤©é …ç›®`);
                        
                        // æª¢æŸ¥æ¶ˆæ¯åˆ—è¡¨æ•¸æ“š
                        console.log('ç•¶å‰æ¶ˆæ¯åˆ—è¡¨æ•¸æ“š:', this.msglist);
                        
                        // æª¢æŸ¥åœ–ç‰‡å®¹å™¨
                        const imageContainers = document.querySelectorAll('.image-container');
                        console.log(`æ‰¾åˆ° ${imageContainers.length} å€‹åœ–ç‰‡å®¹å™¨`);
                        
                        // å¦‚æœæ¶ˆæ¯åˆ—è¡¨ä¸­æœ‰åœ–ç‰‡æ¶ˆæ¯ä½†DOMä¸­æ²’æœ‰åœ–ç‰‡å…ƒç´ ï¼Œå˜—è©¦å¼·åˆ¶æ›´æ–°
                        const hasImageMessages = this.msglist.some(item => item.msg && item.msg.Media === 4);
                        if (hasImageMessages) {
                            console.log('æ¶ˆæ¯åˆ—è¡¨ä¸­æœ‰åœ–ç‰‡æ¶ˆæ¯ï¼Œä½†DOMä¸­æ²’æœ‰åœ–ç‰‡å…ƒç´ ï¼Œå˜—è©¦å¼·åˆ¶æ›´æ–°');
                            this.$forceUpdate();
                        }
                        
                        return;
                    }
                    
                    console.log(`æ‰¾åˆ° ${allImages.length} å€‹åœ–ç‰‡å…ƒç´ ï¼Œé–‹å§‹æª¢æŸ¥`);
                    
                    allImages.forEach((img, index) => {
                        console.log(`åœ–ç‰‡ ${index+1}:`, {
                            src: img.src,
                            visible: this.isElementVisible(img),
                            size: {
                                width: img.width,
                                height: img.height
                            },
                            naturalSize: {
                                width: img.naturalWidth,
                                height: img.naturalHeight
                            },
                            style: img.getAttribute('style') || 'ç„¡æ¨£å¼',
                            className: img.className
                        });
                        
                        // å¦‚æœåœ–ç‰‡åŠ è¼‰å®Œæˆä½†æ²’æœ‰é¡¯ç¤ºï¼Œå˜—è©¦å¼·åˆ¶æ›´æ–°
                        if (img.complete && img.naturalWidth === 0) {
                            console.warn(`åœ–ç‰‡ ${index+1} åŠ è¼‰å®Œæˆä½†å°ºå¯¸ç‚ºé›¶ï¼Œå˜—è©¦é‡æ–°åŠ è¼‰`);
                            const currentSrc = img.src;
                            img.src = '';
                            setTimeout(() => {
                                img.src = currentSrc;
                            }, 100);
                        }
                    });
                },
                // æª¢æŸ¥å…ƒç´ æ˜¯å¦å¯è¦‹
                isElementVisible: function(el) {
                    if (!el) return false;
                    
                    const rect = el.getBoundingClientRect();
                    const vWidth = window.innerWidth || document.documentElement.clientWidth;
                    const vHeight = window.innerHeight || document.documentElement.clientHeight;
                    
                    // æª¢æŸ¥å…ƒç´ æ˜¯å¦åœ¨è¦–çª—å…§
                    if (
                        rect.right < 0 ||
                        rect.bottom < 0 ||
                        rect.left > vWidth ||
                        rect.top > vHeight
                    ) {
                        return false;
                    }
                    
                    // æª¢æŸ¥å…ƒç´ å°ºå¯¸
                    if (rect.width === 0 || rect.height === 0) {
                        return false;
                    }
                    
                    return true;
                },
                
                // æª¢æŸ¥URLæ˜¯å¦ç‚ºæœ‰æ•ˆçš„åœ–ç‰‡URL
                isValidImageUrl: function(url) {
                    if (!url) return false;
                    
                    // ç¢ºä¿ä¸æ˜¯ç´”æ•¸å­—æˆ–ç°¡å–®æ–‡æœ¬
                    if (/^\d+$/.test(url) || url.length < 4) {
                        return false;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦åŒ…å«åœ–ç‰‡æª”æ¡ˆå‰¯æª”å
                    const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
                    const hasExtension = validExtensions.some(ext => 
                        url.toLowerCase().includes(ext)
                    );
                    
                    // å¦‚æœåŒ…å«æª”æ¡ˆå‰¯æª”åæˆ–åŒ…å«æª”æ¡ˆè·¯å¾‘ï¼Œå‰‡èªç‚ºæ˜¯æœ‰æ•ˆçš„åœ–ç‰‡URL
                    return hasExtension || 
                           url.includes('/asset/files/') || 
                           url.includes('/web/asset/') ||
                           url.includes('file_');
                },
                
                handleAvatarError(e) {
                    console.warn('é ­åƒè¼‰å…¥å¤±æ•¸ï¼Œä½¿ç”¨é è¨­é ­åƒ');
                    e.target.src = '/web/asset/images/avatar0.png';
                },
                initUser() {
                    let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                    // ç¢ºä¿é ­åƒ URL æ­£ç¢º
                    let avatarUrl = userInfo.Avatar;
                    if (avatarUrl && !avatarUrl.startsWith('http') && !avatarUrl.startsWith('/')) {
                        avatarUrl = '/web/asset/images/' + avatarUrl;
                    }
                    
                    this.info.icon = avatarUrl;
                    this.info.name = userInfo.Name;
                    this.info.id = userInfo.ID;
                    this.profile.avatar = avatarUrl;
                    this.profile.nickname = userInfo.Name;
                    
                    console.log('åˆå§‹åŒ–ç”¨æˆ¶ä¿¡æ¯ï¼š', {
                        icon: this.info.icon,
                        avatar: this.profile.avatar,
                        name: this.info.name
                    });
                },
                playaudio: function (url) {
                    document.getElementById('audio4play').src = url;
                    document.getElementById('audio4play').play();
                },
                startrecorder: function () {
                    let audioTarget = document.getElementById('audio');
                    var types = ["video/webm",
                        "audio/webm",
                        "video/webm\;codecs=vp8",
                        "video/webm\;codecs=daala",
                        "video/webm\;codecs=h264",
                        "audio/webm\;codecs=opus",
                        "video/mpeg"];
                    var suporttype = "";
                    for (var i in types) {
                        if (MediaRecorder.isTypeSupported(types[i])) {
                            suporttype = types[i];
                        }
                    }
                    if (!suporttype) {
                        mui.toast("ç·¨ç¢¼ä¸æ”¯æŒ")
                        return;
                    }

                    this.duration = new Date().getTime();
                    //video æ”åƒé ­   ï¼Œaudio éŸ³é »
                    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                        .then(function (stream) {
                            this.showprocess = true
                            this.recorder = new MediaRecorder(stream);
                            audioTarget.srcObject = stream;
                            // æ˜¯å¦å¯ç”¨
                            this.recorder.ondataavailable = (event) => {
                                console.log("ondataavailable");
                                uploadblob("attach/upload", event.data, ".mp3", res => {
                                    var duration = Math.ceil((new Date().getTime() - this.duration) / 1000);
                                    this.sendaudiomsg(res.Data, duration);
                                })
                                stream.getTracks().forEach(function (track) {
                                    track.stop();
                                });
                                this.showprocess = false
                            }
                            this.recorder.start();
                        }.bind(this)).
                        catch(function (err) {
                            console.log(err)
                            mui.toast(err)
                            this.showprocess = false
                        }.bind(this));
                },
                stoprecorder: function () {
                    if (typeof this.recorder.stop == "function") {
                        this.recorder.stop();
                    }
                    this.showprocess = false
                    console.log("stoprecorder")

                },
                dispatchplugin: function (item) {
                    switch (item.id) {
                        case "upload":
                        case "camera":

                            break;
                        default:
                            mui.toast("ç³»çµ±æš«ä¸æ”¯æŒï¼Œè«‹è‡ªè¡Œæ“´å±•")
                    }
                },
                reset: function () {
                    this.panelstat = "kbord";
                    this.txtstat = "kbord";
                    this.txtmsg = "";
                },
                createmsgcontext: function () {
                    return {
                        TargetId: this.msgcontext.TargetId,
                        Type: this.msgcontext.Type,
                        CreateTime: new Date().getTime(),
                        userId: userId(),
                        Media: 1, // é»˜èªæ–‡å­—é¡å‹
                        Content: "",
                        Url: "",
                        Amount: 0
                    };
                },
                loaddoutures: function () {
                    var res = [];
                    var config = this.doutu.config;
                    for (var i in config.pkgids) {
                        res[config.pkgids[i]] = (config.baseurl + "/" + config.pkgids[i] + "/info.json")
                    }
                    var that = this;
                    for (var id in res) {
                        this.$http.get(res[id]).then(response => {
                            pkginfo = response.data
                            var baseurl = config.baseurl + "/" + pkginfo.id + "/"
                            // console.log("post res[i]",id,res[id],pkginfo)
                            for (var j in pkginfo.assets) {
                                pkginfo.assets[j] = baseurl + pkginfo.assets[j];
                            }
                            pkginfo.icon = baseurl + pkginfo.icon;
                            that.doutu.packages.push(pkginfo)
                            if (that.doutu.choosed.pkgid == pkginfo.id) {
                                that.doutu.choosed.assets = pkginfo.assets;
                            }

                        })
                    }
                },
                showweixin: function () {
                    mui.alert("è«‹åŠ å¾®ä¿¡è™Ÿxxxç´¢å–")
                },
                showmsg: function (user, msg, isReverse, isFirst) {
                    console.log('é¡¯ç¤ºæ¶ˆæ¯ï¼š', {
                        user: user,
                        msg: msg,
                        isReverse: isReverse,
                        isFirst: isFirst
                    });

                    const currentUserId = parseInt(util.parseQuery("userId"));
                    
                    // æ¨™æº–åŒ–æ¶ˆæ¯æ ¼å¼ï¼Œç¢ºä¿å…¼å®¹å…©ç¨®å±¬æ€§å‘½åé¢¨æ ¼
                    const normalizedMsg = {
                        ...msg,
                        Type: msg.Type || msg.type || 1,
                        Media: Number(msg.Media || msg.media || 1),  // ç¢ºä¿ Media æ˜¯æ•¸å­—é¡å‹
                        media: Number(msg.Media || msg.media || 1),  // åŒæ™‚è¨­ç½®å°å¯«ç‰ˆæœ¬ï¼Œç¢ºä¿ä¸€è‡´æ€§
                        Content: msg.Content || msg.content || "",
                        content: msg.Content || msg.content || "",  // åŒæ™‚è¨­ç½®å°å¯«ç‰ˆæœ¬
                        user_id: msg.user_id || msg.userId,
                        userId: msg.userId || msg.user_id,
                        target_id: msg.target_id || msg.TargetId,
                        TargetId: msg.TargetId || msg.target_id,
                        url: msg.url || msg.Url || msg.Content || msg.content || "",
                        Url: msg.url || msg.Url || msg.Content || msg.content || ""  // ç¢ºä¿å¤§å¯«ç‰ˆæœ¬ä¹Ÿæœ‰å€¼
                    };
                    
                    // å¦‚æœæ˜¯åœ–ç‰‡æ¶ˆæ¯ï¼Œè¼¸å‡ºç‰¹å®šçš„æ—¥èªŒä¸¦å˜—è©¦ç›´æ¥æ¸²æŸ“
                    if (normalizedMsg.Media === 4) {
                        console.log('åœ–ç‰‡æ¶ˆæ¯è©³æƒ…ï¼š', {
                            åŸå§‹æ¶ˆæ¯: msg,
                            æ¨™æº–åŒ–å¾Œ: normalizedMsg,
                            åŸå§‹URLå±¬æ€§: {
                                url: msg.url,
                                Url: msg.Url,
                                content: msg.content,
                                Content: msg.Content
                            },
                            æ¨™æº–åŒ–URL: normalizedMsg.url,
                            å®Œæ•´URL: window.location.origin + (normalizedMsg.url || '')
                        });
                        
                        // æª¢æŸ¥åœ–ç‰‡URLæ˜¯å¦æœ‰æ•ˆ
                        if (this.isValidImageUrl(normalizedMsg.url)) {
                            // å¦‚æœåœ–ç‰‡URLæœ‰æ•ˆï¼Œè¼¸å‡ºèª¿è©¦ä¿¡æ¯ä¸¦ç›´æ¥æ¸¬è©¦åœ–ç‰‡
                            console.log('æœ‰æ•ˆçš„åœ–ç‰‡URLï¼Œå˜—è©¦ç›´æ¥æ¸¬è©¦:', normalizedMsg.url);
                            this.testImageDirectly(normalizedMsg.url);
                        } else {
                            // å¦‚æœåœ–ç‰‡URLç„¡æ•ˆï¼Œè¼¸å‡ºè­¦å‘Š
                            console.warn('ç„¡æ•ˆçš„åœ–ç‰‡URL:', normalizedMsg.url);
                        }
                    }
                    
                    var data = {
                        ismine: (normalizedMsg.user_id === currentUserId || normalizedMsg.userId === currentUserId),
                        user: user,
                        msg: normalizedMsg
                    };
                    
                    console.log('è™•ç†å¾Œçš„æ¶ˆæ¯æ•¸æ“šï¼š', data);
                    
                    // åœ–ç‰‡æ¶ˆæ¯ç‰¹æ®Šè™•ç†ï¼Œç¢ºä¿æ¸²æŸ“æ™‚æœ‰å®Œæ•´å±¬æ€§
                    if (data.msg.Media === 4) {
                        data.msg.url = data.msg.url || data.msg.Url || data.msg.Content;
                        data.msg.Url = data.msg.url;
                        data.msg.Content = data.msg.url;
                    }
                    
                    if (isReverse) {
                        this.msglist = [data].concat(this.msglist);
                    } else {
                        if (isFirst) {
                            this.msglist = [data].concat(this.msglist);
                        } else {
                            this.msglist = this.msglist.concat(data)
                        }
                    }
                    
                    if (!isReverse) {
                        this.panelstat = "kbord";
                    }
                    
                    var that = this;
                    that.timer = setTimeout(function () {
                        window.scrollTo(0, document.getElementById("convo").offsetHeight);
                        if (!isReverse) {
                            let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                            let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                            let y = scroll - inner - 80;
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                        } else {
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + 0 + 'px)';
                        }
                        clearTimeout(that.timer)
                    }, 100)
                },
                startrecord: function () {

                },
                // è·Ÿèª°å–®èŠ
                sendtxtmsg: function (txt) {
                    if (!txt.trim()) return;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ç›®æ¨™ç”¨æˆ¶
                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡", this.msgcontext);
                        mui.toast("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡");
                        return;
                    }

                    console.log("ç™¼é€æ¶ˆæ¯ï¼Œä¸Šä¸‹æ–‡:", this.msgcontext);
                    
                        var msg = this.createmsgcontext();
                        msg.Content = txt;
                    msg.Media = 1; // æ–‡å­—é¡å‹
                    msg.TargetId = this.msgcontext.TargetId; // ç¢ºä¿è¨­ç½®ç›®æ¨™ID
                    msg.Type = this.msgcontext.Type; // ç¢ºä¿è¨­ç½®æ¶ˆæ¯é¡å‹
                    
                    console.log("æº–å‚™ç™¼é€çš„æ¶ˆæ¯:", msg);
                    
                    // å…ˆé¡¯ç¤ºæ¶ˆæ¯
                            this.showmsg(userInfo(), msg);
                    
                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    this.txtmsg = "";
                    
                    // ç™¼é€åˆ°æœå‹™å™¨
                    this.sendMessageToServer(msg);
                },
                sendpicmsg: function (url) {
                    if (this.isSending) {
                        return;
                    }
                    this.isSending = true;

                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡", this.msgcontext);
                        mui.toast("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡");
                        this.isSending = false;
                        return;
                    }

                    // ç¢ºä¿URLæ ¼å¼æ­£ç¢º
                    if (url && !url.startsWith('http') && !url.startsWith('/')) {
                        url = '/' + url;
                    }

                    console.log('æº–å‚™ç™¼é€åœ–ç‰‡æ¶ˆæ¯ï¼š', {
                        url: url,
                        fullUrl: window.location.origin + url,
                        fileName: url.split('/').pop(),
                        targetId: this.msgcontext.TargetId,
                        type: this.msgcontext.Type
                    });

                    // å‰µå»ºæ¨™æº–åŒ–çš„åœ–ç‰‡æ¶ˆæ¯å°è±¡
                    const currentUserId = parseInt(util.parseQuery("userId"));
                    const msgObj = {
                        userId: currentUserId,
                        TargetId: this.msgcontext.TargetId,
                        Type: this.msgcontext.Type,
                        Media: 4,  // ä¸€å®šè¦æ˜¯æ•¸å­—ï¼Œä¸èƒ½æ˜¯å­—ç¬¦ä¸²
                        media: 4,  // å°å¯«å±¬æ€§ä¹Ÿè¨­ç½®
                        url: url,
                        Url: url,
                        Content: url,
                        CreateTime: new Date().toISOString(),
                        id: new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9)
                    };
                    
                    console.log('å‰µå»ºçš„æ¶ˆæ¯å°è±¡ï¼š', msgObj);
                    
                    // ç›´æ¥å‰µå»ºæ¶ˆæ¯æ•¸æ“šä¸¦æ·»åŠ åˆ°åˆ—è¡¨
                    const msgData = {
                        ismine: true,
                        user: userInfo(),
                        msg: msgObj
                    };
                    
                    console.log('æº–å‚™å°‡åœ–ç‰‡æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨', {
                        æ¶ˆæ¯å°è±¡: msgObj,
                        Mediaæ•¸å€¼: msgObj.Media,  // æª¢æŸ¥Mediaå±¬æ€§æ˜¯å¦ç‚ºæ•¸å­—
                        æ¶ˆæ¯æ•¸æ“š: msgData
                    });
                    
                    // å°‡æ–°æ¶ˆæ¯æ·»åŠ åˆ°åˆ—è¡¨
                    this.msglist.push(msgData);
                    
                    // ç¢ºä¿æ¶ˆæ¯è¢«è™•ç†
                    if (!this.processedMessages) {
                        this.processedMessages = {};
                    }
                    this.processedMessages[msgObj.id] = true;
                    
                    // ç™¼é€åˆ°æœå‹™å™¨
                    this.sendMessageToServer(msgObj);
                    
                    // å¼·åˆ¶ Vue æ›´æ–°è¦–åœ–
                    this.$nextTick(() => {
                        this.$forceUpdate();
                        
                        // æ»¾å‹•åˆ°åº•éƒ¨
                        setTimeout(() => {
                            window.scrollTo(0, document.getElementById("convo").offsetHeight);
                            let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                            let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                            let y = scroll - inner - 80;
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                            
                            // æŸ¥çœ‹æ›´æ–°å¾Œçš„åœ–ç‰‡å…ƒç´ 
                            this.checkAllImages();
                        }, 200);
                    });
                    
                    // é‡è¨­ç™¼é€ç‹€æ…‹
                    setTimeout(() => {
                        this.isSending = false;
                    }, 1000);
                },
                sendaudiomsg: function (url, duration) {
                        var msg = this.createmsgcontext();
                    msg.Url = url;
                    msg.Media = 3; // èªéŸ³é¡å‹
                    msg.Amount = duration;
                    
                    // å…ˆé¡¯ç¤ºæ¶ˆæ¯
                            this.showmsg(userInfo(), msg);
                    
                    // ç™¼é€åˆ°æœå‹™å™¨
                    this.sendMessageToServer(msg);
                },
                scrollConcat() {
                    console.log(123)
                },
                closePanel() {
                    this.panelstat = 'kbord';
                },
                singlemsg: function (user) {
                    // æª¢æŸ¥ç”¨æˆ¶å°è±¡æ˜¯å¦æœ‰æ•ˆ
                    if (!user) {
                        console.error("ç”¨æˆ¶å°è±¡ç‚ºç©º");
                        mui.toast("ç„¡æ³•ç²å–ç”¨æˆ¶ä¿¡æ¯");
                        return;
                    }

                    // æª¢æŸ¥å¿…è¦çš„ç”¨æˆ¶å±¬æ€§
                    if (!user.ID && !user.id) {
                        console.error("ç”¨æˆ¶IDç„¡æ•ˆ:", user);
                        mui.toast("ç”¨æˆ¶IDç„¡æ•ˆ");
                        return;
                    }

                    // çµ±ä¸€ä½¿ç”¨ ID å±¬æ€§
                    const userId = user.ID || user.id;
                    const userName = user.name || user.Name;
                    const userAvatar = user.Avatar || user.avatar;

                    // ç¢ºä¿é ­åƒURLæ­£ç¢º
                    let avatarUrl = userAvatar;
                    if (avatarUrl && !avatarUrl.startsWith("http") && !avatarUrl.startsWith("/")) {
                        avatarUrl = "/web/asset/images/" + avatarUrl;
                    }

                    console.log("é–‹å§‹èŠå¤©ï¼Œç”¨æˆ¶ä¿¡æ¯:", {
                        id: userId,
                        name: userName,
                        avatar: avatarUrl
                    });
                    
                    if (this.isDisable) {
                        this.setTimeFlag();
                        this.win = "single";
                        this.title = "å’Œã€" + userName + "ã€‘èŠå¤©ä¸­";
                        this.otherAvatar = avatarUrl || "/web/asset/images/avatar0.png";
                        
                        // ç¢ºä¿æ­£ç¢ºè¨­ç½®ç›®æ¨™IDå’Œé¡å‹
                        const targetId = parseInt(userId);
                        if (isNaN(targetId)) {
                            console.error("ç”¨æˆ¶IDç„¡æ•ˆ:", userId);
                            mui.toast("ç”¨æˆ¶IDç„¡æ•ˆ");
                            return;
                        }
                        
                        // é‡ç½®æ¶ˆæ¯åˆ—è¡¨å’Œåˆ†é ä¿¡æ¯
                        this.msglist = [];
                        this.currentPage = 1;
                        this.isLoadingHistory = false;
                        this.hasMoreHistory = true;
                        this.lastScrollPosition = 0;
                        
                        // é‡è¦ï¼šå…ˆè¨­ç½®ä¸Šä¸‹æ–‡ï¼Œç„¶å¾Œç«‹å³åŠ è¼‰æ­·å²è¨˜éŒ„
                        this.msgcontext = {
                            TargetId: targetId,
                            Type: 1, // ç§èŠé¡å‹
                            CreateTime: new Date().getTime(),
                            userId: this.info.id || util.parseQuery("userId")
                        };
                        
                        console.log("è¨­ç½®èŠå¤©ä¸Šä¸‹æ–‡:", this.msgcontext);
                        
                        // åŠ è¼‰èŠå¤©æ­·å²
                        this.loadMoreHistory();
                        
                        // ä½¿ç”¨ Vue çš„ nextTick ç¢ºä¿ DOM å·²æ›´æ–°
                        this.$nextTick(() => {
                            // è¨­ç½®æ»¾å‹•
                            const scrollWrapper = document.querySelector('.mui-scroll-wrapper');
                            if (scrollWrapper) {
                                mui(scrollWrapper).scroll({
                                    scrollY: true,
                                    scrollX: false,
                                    startX: 0,
                                    startY: 0,
                                    indicators: true,
                                    deceleration: 0.0006,
                                    bounce: true
                                });

                                // ç›£è½æ»¾å‹•äº‹ä»¶
                                const scrollElement = scrollWrapper.querySelector('.mui-scroll');
                                if (scrollElement) {
                                    scrollElement.addEventListener('scroll', this.handleScroll);
                                }
                            }
                            
                            // æ·»åŠ è¨ºæ–·å·¥å…·
                            this.addDiagnosticTools();
                        });
                    }
                },
                // è™•ç†æ»¾å‹•äº‹ä»¶
                handleScroll: function(e) {
                    if (!e.target || !e.target.style || this.isLoadingHistory || !this.hasMoreHistory) {
                        return;
                    }

                    // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–å‹•è¨ˆæ™‚å™¨
                    if (this.debounceTimer) {
                        clearTimeout(this.debounceTimer);
                    }

                    const transform = e.target.style.transform;
                    if (!transform) {
                        return;
                    }

                    const translate = transform.match(/translate3d\(\d+px,\s*(\d+)px,\s*(\d+)px\)/i);
                    if (!translate || translate.length <= 1) {
                        return;
                    }

                    const currentPosition = parseInt(translate[1]);
                    const scrollDiff = Math.abs(currentPosition - this.lastScrollPosition);

                    // ä½¿ç”¨é˜²æŠ–å‹•è™•ç†æ»¾å‹•äº‹ä»¶
                    this.debounceTimer = setTimeout(() => {
                        // åªæœ‰ç•¶æ»¾å‹•è·é›¢è¶…éé–¾å€¼æ™‚æ‰è§¸ç™¼è¼‰å…¥
                        if (scrollDiff > this.scrollThreshold && currentPosition > this.lastScrollPosition) {
                            this.loadingIndicator = true; // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
                            this.loadMoreHistory();
                        }
                    }, 200); // 200ms çš„é˜²æŠ–å‹•å»¶é²

                    this.lastScrollPosition = currentPosition;
                },
                loadMoreHistory: function() {
                    if (this.isLoadingHistory || !this.hasMoreHistory) {
                        return;
                    }

                    // æª¢æŸ¥å¿…è¦çš„åƒæ•¸
                    if (!this.msgcontext.userId || !this.msgcontext.TargetId) {
                        console.error('ç„¡æ•ˆçš„ç”¨æˆ¶IDæˆ–ç›®æ¨™ID:', this.msgcontext);
                        mui.toast('ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„ï¼šåƒæ•¸ç„¡æ•ˆ');
                        return;
                    }

                    // æª¢æŸ¥æ¶ˆæ¯é¡å‹
                    if (![1, 2].includes(this.msgcontext.Type)) {
                        console.error('ç„¡æ•ˆçš„æ¶ˆæ¯é¡å‹:', this.msgcontext.Type);
                        mui.toast('ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„ï¼šæ¶ˆæ¯é¡å‹ç„¡æ•ˆ');
                        return;
                    }

                    this.isLoadingHistory = true;
                    const nextPage = this.currentPage + 1;

                    // é¡¯ç¤ºè¼‰å…¥ä¸­æç¤º
                    const loadingToast = document.createElement('div');
                    loadingToast.className = 'loading-toast';
                    loadingToast.innerHTML = `
                        <style>
                            .loading-toast {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: rgba(0, 0, 0, 0.7);
                                color: white;
                                padding: 10px 20px;
                                border-radius: 5px;
                                z-index: 9999;
                            }
                            .loading-spinner {
                                display: inline-block;
                                width: 20px;
                                height: 20px;
                                border: 2px solid #fff;
                                border-radius: 50%;
                                border-top-color: transparent;
                                animation: spin 1s linear infinite;
                                margin-right: 10px;
                            }
                            @keyframes spin {
                                to {transform: rotate(360deg);}
                            }
                        </style>
                        <div class="loading-spinner"></div>
                        <span>è¼‰å…¥ä¸­...</span>
                    `;
                    document.body.appendChild(loadingToast);

                    // æ ¹æ“šæ¶ˆæ¯é¡å‹é¸æ“‡æ­£ç¢ºçš„ API è·¯å¾‘
                    const endpoint = this.msgcontext.Type === 1 ? 
                        `/chat/private/history?page=${nextPage}&pageSize=20&fromUserId=${this.msgcontext.userId}&toUserId=${this.msgcontext.TargetId}` :
                        `/chat/group/history?page=${nextPage}&pageSize=20&groupId=${this.msgcontext.TargetId}&userId=${this.msgcontext.userId}`;

                    fetch(endpoint, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        try {
                            if (!text || text.trim() === '') {
                                return { code: 0, data: [] };
                            }
                            return JSON.parse(text);
                        } catch (e) {
                            console.error("è§£æéŸ¿æ‡‰å¤±æ•—:", e);
                            throw new Error("ç„¡æ•ˆçš„éŸ¿æ‡‰æ ¼å¼");
                        }
                    })
                    .then(res => {
                        if (res.code === 0) {
                            const messages = res.data || [];
                            
                            // å¦‚æœæ²’æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œæ¨™è¨˜å·²åˆ°é”åº•éƒ¨
                            if (messages.length === 0) {
                                this.hasMoreHistory = false;
                                mui.toast("å·²ç¶“æ²’æœ‰æ›´å¤šè¨˜éŒ„äº†");
                                return;
                            }

                            // æŒ‰æ™‚é–“é †åºæ’åºæ¶ˆæ¯
                            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

                            // é¡¯ç¤ºæ¶ˆæ¯
                            const currentUserId = parseInt(util.parseQuery("userId"));
                            messages.forEach((msg, index) => {
                                const messageData = {
                                    ...msg,
                                    type: 1,
                                    media: msg.media || 1,
                                    user_id: msg.user_id,
                                    target_id: msg.target_id,
                                    content: msg.content
                                };

                                if (messageData.user_id === currentUserId) {
                                    this.loaduserinfo(messageData.user_id, (user) => {
                                        this.showmsg(user, messageData, true);
                                    });
                                } else {
                                    this.loaduserinfo(messageData.user_id, (user) => {
                                        this.showmsg(user, messageData, true);
                                    });
                                }
                            });

                            this.currentPage = nextPage;
                        }
                    })
                    .catch(error => {
                        console.error("è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—:", error);
                        mui.toast("è¼‰å…¥æ­·å²è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
                        this.hasMoreHistory = false;
                    })
                    .finally(() => {
                        this.isLoadingHistory = false;
                        this.loadingIndicator = false;
                        // ç§»é™¤è¼‰å…¥ä¸­æç¤º
                        const loadingToast = document.querySelector('.loading-toast');
                        if (loadingToast) {
                            loadingToast.remove();
                        }
                    });
                },
                // ç¾¤èŠçš„åˆå§‹åŒ–
                groupmsg: function (group) {
                    if (this.isDisable) {
                        this.setTimeFlag()
                        this.win = "group";
                        this.title = group.name;
                        this.msgcontext.TargetId = parseInt(group.id);
                        this.msgcontext.Type = 2;
                    }
                },
                loaduserinfo: function (userid, cb) {
                    if (!userid) {
                        console.error("ç”¨æˆ¶IDç„¡æ•ˆ");
                        return;
                    }
                    
                    userid = "" + userid;
                    var userinfo = this.usermap[userid];
                    
                    if (!userinfo) {
                        // åªåœ¨é¦–æ¬¡åŠ è¼‰æ™‚è¼¸å‡ºæ—¥èªŒ
                        console.log("é¦–æ¬¡åŠ è¼‰ç”¨æˆ¶ä¿¡æ¯:", userid);
                        
                        fetch("/user/find", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({ userId: parseInt(userid) })
                        })
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(`HTTP error! status: ${res.status}`);
                            }
                            return res.json();
                        })
                        .then(res => {
                            if (res.code === 0 && res.data) {
                                // ç¢ºä¿é ­åƒURLæ­£ç¢º
                                if (res.data.Avatar && !res.data.Avatar.startsWith("http")) {
                                    res.data.Avatar = "/web/asset/images/" + res.data.Avatar;
                                }
                                this.usermap[userid] = res.data;
                                cb(res.data);
                    } else {
                                console.error("ç²å–ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:", res.message);
                                // ä½¿ç”¨é è¨­é ­åƒ
                                const defaultUser = {
                                    ID: parseInt(userid),
                                    Name: "æœªçŸ¥ç”¨æˆ¶",
                                    Avatar: "/web/asset/images/avatar0.png"
                                };
                                this.usermap[userid] = defaultUser;
                                cb(defaultUser);
                            }
                        })
                        .catch(err => {
                            console.error("åŠ è¼‰ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:", err);
                            // ä½¿ç”¨é è¨­é ­åƒ
                            const defaultUser = {
                                ID: parseInt(userid),
                                Name: "æœªçŸ¥ç”¨æˆ¶",
                                Avatar: "/web/asset/images/avatar0.png"
                            };
                            this.usermap[userid] = defaultUser;
                            cb(defaultUser);
                        });
                    } else {
                        // ä½¿ç”¨ç·©å­˜æ™‚ä¸è¼¸å‡ºæ—¥èªŒ
                        cb(userinfo);
                    }
                },
                onmessage: function (data) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºå¿ƒè·³æ¶ˆæ¯
                    if (data.Media === -1 && data.Type === 3) {
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“è™•ç†éé€™æ¢æ¶ˆæ¯
                    if (this.processedMessages && this.processedMessages[data.id]) {
                        return;
                    }

                    // æ¨™è¨˜æ¶ˆæ¯ç‚ºå·²è™•ç†
                    if (!this.processedMessages) {
                        this.processedMessages = {};
                    }
                    this.processedMessages[data.id] = true;

                    // å¦‚æœæ˜¯è‡ªå·±çš„æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›ï¼ˆå› ç‚ºå·²ç¶“åœ¨ç™¼é€æ™‚é¡¯ç¤ºéäº†ï¼‰
                    if (data.userId === userId()) {
                        return;
                    }

                    // è™•ç†å°æ–¹çš„æ¶ˆæ¯
                    this.loaduserinfo(data.userId, function (user) {
                        this.showmsg(user, data);

                        // æ›´æ–°å¥½å‹åˆ—è¡¨ä¸­çš„æœ€å¾Œä¸€æ¢æ¶ˆæ¯
                        this.friends.forEach((item) => {
                            if (item.ID == data.userId) {
                                // 1æ–‡å­— 2è¡¨æƒ…åŒ… 3åœ–ç‰‡ 4éŸ³é »
                                if (data.Media === 1) {
                                    item.memo = data.Content;
                                } else if (data.Media === 2) {
                                    item.memo = data.Url;
                                } else if (data.Media === 3) {
                                    item.memo = "[èªéŸ³]";
                                } else if (data.Media === 4) {
                                    item.memo = "[åœ–ç‰‡]";
                                }
                            }
                        });
                    }.bind(this));
                },
                initWebSocket() {
                    const currentUserId = userId(); // ä½¿ç”¨å…¨å±€å‡½æ•¸
                    if (!currentUserId) {
                        console.error('ç„¡æ³•åˆå§‹åŒ– WebSocketï¼šæœªæ‰¾åˆ°ç”¨æˆ¶ ID');
                        return;
                    }

                    if (this.isConnecting) {
                        console.log("WebSocket æ­£åœ¨é€£æ¥ä¸­ï¼Œè·³éé‡é€£");
                        return;
                    }

                    this.isConnecting = true;

                    const wsUrl = `ws://${window.location.host}/chat/ws?userId=${currentUserId}`;
                    console.log("æ­£åœ¨é€£æ¥ WebSocket:", wsUrl);

                    try {
                        this.webSocket = new WebSocket(wsUrl);

                        this.webSocket.onopen = () => {
                            console.log('WebSocket é€£æ¥å·²å»ºç«‹');
                            this.isConnecting = false;
                            this.reconnectAttempts = 0;
                            this.startHeartbeat();
                            this.processMessageQueue();
                        };

                        this.webSocket.onmessage = (event) => {
                            try {
                                const message = JSON.parse(event.data);
                                console.log("æ”¶åˆ° WebSocket æ¶ˆæ¯:", message);
                                
                                // å¿½ç•¥å¿ƒè·³æ¶ˆæ¯
                                if (message.Media === -1 && message.Type === 3) {
                                    return;
                                }

                                // æª¢æŸ¥æ˜¯å¦å·²è™•ç†éè©²æ¶ˆæ¯
                                if (this.processedMessages && this.processedMessages[message.id]) {
                                    console.log("æ¶ˆæ¯å·²è™•ç†ï¼Œè·³é:", message.id);
                                    return;
                                }

                                // æ¨™è¨˜æ¶ˆæ¯ç‚ºå·²è™•ç†
                                if (!this.processedMessages) {
                                    this.processedMessages = {};
                                }
                                this.processedMessages[message.id] = true;

                                // å¦‚æœæ˜¯è‡ªå·±ç™¼é€çš„æ¶ˆæ¯ï¼Œä¸éœ€è¦å†é¡¯ç¤º
                                if (message.userId === currentUserId) {
                                    return;
                                }

                                // ç¢ºä¿æ¶ˆæ¯æ ¼å¼æ¨™æº–åŒ–
                                const normalizedMessage = {
                                    ...message,
                                    user_id: message.userId,  // å…¼å®¹å¾Œç«¯æ ¼å¼
                                    target_id: message.TargetId,  // å…¼å®¹å¾Œç«¯æ ¼å¼
                                    content: message.Content,  // å…¼å®¹å¾Œç«¯æ ¼å¼
                                    type: message.Type,        // å…¼å®¹å¾Œç«¯æ ¼å¼
                                    media: message.Media       // å…¼å®¹å¾Œç«¯æ ¼å¼
                                };
                                
                                // ç¢ºä¿åœ–ç‰‡æ¶ˆæ¯æœ‰æ­£ç¢ºçš„ url å±¬æ€§
                                if (message.Media === 4) {
                                    // æª¢æŸ¥å¯èƒ½çš„åœ–ç‰‡URLä¾†æº
                                    normalizedMessage.url = message.Url || message.url || message.Content;
                                    
                                    console.log("è™•ç†åœ–ç‰‡æ¶ˆæ¯:", {
                                        åŸå§‹æ¶ˆæ¯: message,
                                        æ¨™æº–åŒ–å¾Œ: normalizedMessage,
                                        åœ–ç‰‡å±¬æ€§: {
                                            Url: message.Url,
                                            url: message.url,
                                            Content: message.Content
                                        },
                                        æœ€çµ‚URL: normalizedMessage.url,
                                        å®Œæ•´URLè·¯å¾‘: window.location.origin + (normalizedMessage.url || '')
                                    });
                                    
                                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•URLï¼Œè¼¸å‡ºè­¦å‘Š
                                    if (!normalizedMessage.url) {
                                        console.error("è­¦å‘Šï¼šç„¡æ³•å¾æ¶ˆæ¯ä¸­æå–åœ–ç‰‡URL", message);
                                    }
                                }

                                // è™•ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
                                this.loaduserinfo(message.userId, (user) => {
                                    this.showmsg(user, normalizedMessage);
                                });
                            } catch (error) {
                                console.error("è™•ç† WebSocket æ¶ˆæ¯æ™‚å‡ºéŒ¯:", error);
                            }
                        };

                        this.webSocket.onerror = (error) => {
                            console.error('WebSocket éŒ¯èª¤ï¼š', error);
                            this.isConnecting = false;
                        };

                        this.webSocket.onclose = () => {
                            console.log('WebSocket é€£æ¥å·²é—œé–‰');
                            this.isConnecting = false;
                            // å˜—è©¦é‡æ–°é€£æ¥
                            setTimeout(() => this.initWebSocket(), 5000);
                        };
                    } catch (error) {
                        console.error("åˆå§‹åŒ– WebSocket æ™‚å‡ºéŒ¯:", error);
                        this.isConnecting = false;
                        setTimeout(() => this.initWebSocket(), 5000);
                    }
                },
                handleIncomingMessage(message) {
                    // æ ¹æ“šè¨Šæ¯é¡å‹è™•ç†æ¥æ”¶åˆ°çš„è¨Šæ¯
                    if (message.type === 1) { // ç§äººè¨Šæ¯
                        this.msglist.push({
                            ismine: false,
                            msg: message
                        });
                    } else if (message.type === 2) { // ç¾¤çµ„è¨Šæ¯
                        this.msglist.push({
                            ismine: false,
                            msg: message
                        });
                    }
                    // æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯
                    this.$nextTick(() => {
                        const container = document.querySelector('.mui-scroll');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                        }
                    });
                },
                async sendtxtmsg(content) {
                    if (!content.trim()) return;
                    
                    const currentUserId = userId(); // ä½¿ç”¨å…¨å±€å‡½æ•¸
                    if (!currentUserId) {
                        console.error("æœªæ‰¾åˆ°ç”¨æˆ¶ID");
                        mui.toast("è«‹å…ˆç™»å…¥");
                        return;
                    }

                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡", this.msgcontext);
                        mui.toast("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡");
                        return;
                    }

                    const message = {
                        fromUserId: currentUserId,
                        toUserId: this.msgcontext.TargetId,
                        content: content,
                        type: this.msgcontext.Type,
                        media: 1
                    };

                    try {
                        // å…ˆåœ¨æœ¬åœ°é¡¯ç¤ºæ¶ˆæ¯
                        const localMsg = {
                            userId: message.fromUserId,
                            TargetId: message.toUserId,
                            Content: message.content,
                            Type: message.type,
                            Media: message.media,
                            CreatedAt: new Date()
                        };
                        this.showmsg(userInfo(), localMsg);

                        // æ¸…ç©ºè¼¸å…¥æ¡†
                        this.txtmsg = '';

                        // ç™¼é€åˆ° WebSocket
                        this.sendMessageToServer({
                            ...localMsg,
                            id: new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9)
                        });

                        // åŒæ™‚ç™¼é€åˆ° HTTP API
                        const endpoint = message.type === 1 ? '/chat/private/send' : '/chat/group/send';
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify(message)
                        });

                        if (!response.ok) {
                            throw new Error('ç™¼é€è¨Šæ¯å¤±æ•—');
                        }
                    } catch (error) {
                        console.error('ç™¼é€è¨Šæ¯å¤±æ•—ï¼š', error);
                        mui.toast('ç™¼é€è¨Šæ¯å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
                    }
                },
                async sendpicmsg(url) {
                    if (this.isSending) return;
                    this.isSending = true;

                    const currentUserId = userId(); // ä½¿ç”¨å…¨å±€å‡½æ•¸
                    if (!currentUserId) {
                        console.error("æœªæ‰¾åˆ°ç”¨æˆ¶ID");
                        mui.toast("è«‹å…ˆç™»å…¥");
                        this.isSending = false;
                        return;
                    }

                    if (!this.msgcontext.TargetId || this.msgcontext.TargetId <= 0) {
                        console.error("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡", this.msgcontext);
                        mui.toast("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡");
                        this.isSending = false;
                        return;
                    }

                    const message = {
                        fromUserId: currentUserId,
                        toUserId: this.msgcontext.TargetId,
                        content: url,
                        type: this.msgcontext.Type,
                        media: 4
                    };

                    try {
                        // å…ˆåœ¨æœ¬åœ°é¡¯ç¤ºæ¶ˆæ¯
                        const localMsg = {
                            userId: message.fromUserId,
                            TargetId: message.toUserId,
                            Content: message.content,
                            Type: message.type,
                            Media: message.media,
                            url: url,
                            CreatedAt: new Date()
                        };
                        this.showmsg(userInfo(), localMsg);

                        // ç™¼é€åˆ° WebSocket
                        this.sendMessageToServer({
                            ...localMsg,
                            id: new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9)
                        });

                        // åŒæ™‚ç™¼é€åˆ° HTTP API
                        const endpoint = message.type === 1 ? '/chat/private/send' : '/chat/group/send';
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify(message)
                        });

                        if (!response.ok) {
                            throw new Error('ç™¼é€åœ–ç‰‡å¤±æ•—');
                        }

                        // é—œé–‰é¢æ¿
                        this.panelstat = 'kbord';
                    } catch (error) {
                        console.error('ç™¼é€åœ–ç‰‡å¤±æ•—ï¼š', error);
                        mui.toast('ç™¼é€åœ–ç‰‡å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
                    } finally {
                        setTimeout(() => {
                            this.isSending = false;
                        }, 1000);
                    }
                },
                sendMessageToServer: function (msg) {
                    if (!msg || !msg.TargetId || msg.TargetId <= 0) {
                        console.error("ç„¡æ•ˆçš„æ¶ˆæ¯æˆ–ç›®æ¨™ID:", msg);
                        return;
                    }

                    // ç”Ÿæˆæ¶ˆæ¯ID
                    msg.id = new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        this.webSocket.send(JSON.stringify(msg));
                        } else {
                        console.log("WebSocket æœªé€£æ¥ï¼Œæ¶ˆæ¯åŠ å…¥éšŠåˆ—");
                        this.messageQueue.push(msg);
                        if (!this.isConnecting) {
                            this.initWebSocket();
                        }
                    }
                },
                startHeartbeat: function () {
                    if (this.heartbeatTimer) {
                        clearInterval(this.heartbeatTimer);
                    }
                    
                    // æ¯ 60 ç§’ç™¼é€ä¸€æ¬¡å¿ƒè·³
                    this.heartbeatTimer = setInterval(() => {
                        if (this.webSocket && this.webSocket.readyState === 1) {
                            this.heartbeat();
                        }
                    }, 60000);
                },
                heartbeat() {
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        var msg = this.createmsgcontext();
                        msg.Media = -1;
                        msg.Type = 3;
                        msg.Content = "å¿ƒè·³";
                        this.webSocket.send(JSON.stringify(msg));
                    }
                },
                loadfriends: function () {
                    fetch("/user/searchFriends", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        },
                        body: JSON.stringify({
                            userId: userId()
                        })
                    })
                        .then(response => response.json())
                        .then(res => {
                        if (res.code === 0) {
                            this.friends = res.rows || [];
                            let usermap = {};
                            for (let i in this.friends) {
                                const k = "" + this.friends[i].id;
                                usermap[k] = this.friends[i];
                            }
                            console.log("å¥½å‹åˆ—è¡¨åŠ è¼‰å®Œæˆ:", this.friends);
                            console.log("ç”¨æˆ¶æ˜ å°„:", usermap);
                            this.usermap = usermap;
                        } else {
                            console.error("åŠ è¼‰å¥½å‹åˆ—è¡¨å¤±æ•—:", res.message);
                        }
                        })
                        .catch(err => {
                        console.error("åŠ è¼‰å¥½å‹åˆ—è¡¨è«‹æ±‚å¤±æ•—:", err);
                        });
                },
                loadcommunitys: function () {
                    fetch(`/contact/groups?userId=${userId()}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        }
                    })
                    .then(response => response.json())
                    .then(res => {
                        if (res.code === 0) {
                            this.communitys = res.data || [];
                        } else {
                            console.error("åŠ è¼‰ç¾¤çµ„åˆ—è¡¨å¤±æ•—:", res.message);
                        }
                    })
                    .catch(err => {
                        console.error("åŠ è¼‰ç¾¤çµ„åˆ—è¡¨è«‹æ±‚å¤±æ•—:", err);
                    });
                },
                addfriend: function () {
                    //console.log("addfriend....")
                    var that = this;
                    mui.prompt('', 'è«‹è¼¸å…¥å¥½å‹åç¨±', 'åŠ å¥½å‹', ['å–æ¶ˆ', 'ç¢ºèª'], function (e) {
                        if (e.index == 1) {
                            console.log('ğŸ¯ å¥½å‹åç¨±ï¼š', e.value);
                            // åˆ¤æ–·æ•¸å­—
                            //if (isNaN(e.value) || e.value <= 0) {
                            //    mui.toast('æ ¼å¼éŒ¯èª¤');
                            //} else {
                            //mui.toast(e.value);
                            that._addfriend(e.value)
                            //}
                        } else {
                            //mui.toast('æ‚¨å–æ¶ˆäº†å…¥åº«');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';

                },
                _addfriend: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        
                        fetch("/contact/addFriend", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({
                                userId: userId(),
                                targetId: parseInt(dstobj)
                            })
                        })
                            .then(response => response.json())
                            .then(res => {
                            if (res.code === 0) {
                                    mui.toast("æ·»åŠ æˆåŠŸ");
                                    that.loadfriends();
                                } else {
                                mui.toast(res.message || "æ·»åŠ å¤±æ•—");
                                }
                            })
                            .catch(err => {
                            console.error("æ·»åŠ å¥½å‹è«‹æ±‚å¤±æ•—:", err);
                            mui.toast("ç¶²çµ¡éŒ¯èª¤");
                            });
                    }
                },
                // å„äººè³‡æ–™ä¿®æ”¹é¡¯ç¤º
                setUserInfo: function () {
                    this.win = "userinfo"
                    //  console.log("createCom")
                },
                // æ–°å»ºç¾¤é¡¯ç¤º
                createCom: function () {
                    this.win = "community"
                    // åˆå§‹åŒ–ç¾¤èŠæ•¸æ“š
                    this.com = {
                        ownerId: userId(),
                        icon: "",
                        cate: "0",
                        name: "",
                        memo: "",
                        size: "0",
                        joinType: "0"
                    }
                },

                // æ–°å»ºç¾¤æäº¤
                createcommunity: function () {
                    // é©—è­‰è¡¨å–®
                    if (!this.com.name || this.com.name.length < 2 || this.com.name.length > 20) {
                        mui.toast("ç¾¤åç¨±é•·åº¦å¿…é ˆåœ¨2-20å€‹å­—ç¬¦ä¹‹é–“");
                        return;
                    }
                    
                    if (!this.com.memo || this.com.memo.length > 200) {
                        mui.toast("ç¾¤ä»‹ç´¹ä¸èƒ½è¶…é200å­—");
                        return;
                    }
                    
                    if (!this.com.icon) {
                        mui.toast("è«‹ä¸Šå‚³ç¾¤é ­åƒ");
                        return;
                    }

                    this.com.ownerId = userId();
                    
                    fetch("/contact/create-group", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${util.parseQuery("token")}`
                        },
                        body: JSON.stringify(this.com)
                    })
                    .then(response => response.json())
                    .then(res => {
                        if (res.code === 0) {
                            mui.toast("å»ºç¾¤æˆåŠŸ");
                            this.loadcommunitys();
                            this.goBack(); // è¿”å›ä¸Šä¸€é 
                        } else {
                            mui.toast(res.message || "å»ºç¾¤å¤±æ•—");
                        }
                    })
                    .catch(err => {
                        console.error("å‰µå»ºç¾¤çµ„è«‹æ±‚å¤±æ•—:", err);
                        mui.toast("ç¶²çµ¡éŒ¯èª¤");
                    });
                },
                updateUserInfo() {
                    //console.log("createcommunity")
                    this.info.id = userId()
                    util.post("/user/updateUser", this.info).then(res => {
                        console.log(res)
                        let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                        userInfo.Avatar = this.info.icon;
                        userInfo.Name = this.info.name;
                        sessionStorage.setItem('userinfo', JSON.stringify(userInfo))
                        if (res.Code != 0) {
                            mui.toast(res.message)
                        } else {
                            //location.replace("localhost:8081")
                            //location.href = "/"
                            mui.toast("ä¿®æ”¹æˆåŠŸ")
                            //goBack()
                        }
                    })
                },



                //å›åˆ°èŠå¤©é¦–é¡µ
                goBack() {
                    this.win = "main"
                },

                _joincomunity: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        console.log(that);
                        fetch("/contact/joinGroup", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${util.parseQuery("token")}`
                            },
                            body: JSON.stringify({
                                comId: dstobj,
                                userId: userId()
                            })
                        })
                        .then(response => response.json())
                        .then(res => {
                            if (res.code === 0) {
                                mui.toast("åŠ å…¥æˆåŠŸ");
                                that.loadcommunitys();
                            } else {
                                mui.toast(res.message || "åŠ å…¥å¤±æ•—");
                            }
                        })
                        .catch(err => {
                            console.error("åŠ å…¥ç¾¤çµ„è«‹æ±‚å¤±æ•—:", err);
                            mui.toast("ç¶²çµ¡éŒ¯èª¤");
                        });
                    }
                },
                joincom: function () {
                    var that = this;
                    mui.prompt('', 'è¯·è¾“å…¥ç¾¤å·æˆ–è€…ç¾¤åç§°', 'åŠ ç¾¤', ['å–æ¶ˆ', 'ç¡®è®¤'], function (e) {
                        if (e.index == 1) {
                            //    if (isNaN(e.value) || e.value <= 0) {
                            //       mui.toast('æ ¼å¼é”™è¯¯');
                            //   } else {
                            //mui.toast(e.value);
                            that._joincomunity(e.value)
                            // }
                        } else {
                            //mui.toast('æ‚¨å–æ¶ˆäº†å…¥åº“');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';
                },
                quit: function () {
                    sessionStorage.removeItem("userid")
                    sessionStorage.removeItem("userinfo")
                    location.href = "/"
                },
                setTimeFlag() {
                    this.isDisable = false;
                    setTimeout(() => {
                        this.isDisable = true;
                    }, 100)
                },
                // æ·»åŠ  emoji é¸æ“‡å™¨
                showEmojiPicker() {
                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è¡¨æƒ…é¸æ“‡å™¨
                    const existingPicker = document.querySelector('.emoji-picker');
                    if (existingPicker) {
                        document.body.removeChild(existingPicker);
                        return;
                    }

                    var emojiContainer = document.createElement('div');
                    emojiContainer.className = 'emoji-picker';
                    emojiContainer.style.position = 'absolute';
                    emojiContainer.style.bottom = '50px';
                    emojiContainer.style.left = '0';
                    emojiContainer.style.backgroundColor = '#fff';
                    emojiContainer.style.border = '1px solid #ccc';
                    emojiContainer.style.padding = '10px';
                    emojiContainer.style.zIndex = '1000';
                    emojiContainer.style.display = 'grid';
                    emojiContainer.style.gridTemplateColumns = 'repeat(8, 1fr)';
                    emojiContainer.style.gap = '5px';

                    // åŠ è¼‰ emoji åˆ—è¡¨
                    var emojis = [];
                    for (var i = 1; i <= 13; i++) {
                        emojis.push(i + '.gif');
                    }

                    // å‰µå»º emoji æŒ‰éˆ•
                    emojis.forEach(function(emoji) {
                        var emojiBtn = document.createElement('img');
                        emojiBtn.src = '/web/asset/plugins/doutu/emoj/' + emoji;
                        emojiBtn.style.width = '24px';
                        emojiBtn.style.height = '24px';
                        emojiBtn.style.cursor = 'pointer';
                        emojiBtn.onclick = function() {
                            app.sendpicmsg('/web/asset/plugins/doutu/emoj/' + emoji);
                            document.body.removeChild(emojiContainer);
                        };
                        emojiContainer.appendChild(emojiBtn);
                    });

                    // æ·»åŠ é—œé–‰æŒ‰éˆ•
                    var closeBtn = document.createElement('button');
                    closeBtn.textContent = 'é—œé–‰';
                    closeBtn.style.gridColumn = '1 / -1';
                    closeBtn.style.marginTop = '10px';
                    closeBtn.onclick = function() {
                        document.body.removeChild(emojiContainer);
                    };
                    emojiContainer.appendChild(closeBtn);

                    document.body.appendChild(emojiContainer);
                },
                // è™•ç†åœ–ç‰‡åŠ è¼‰éŒ¯èª¤
                handleImageError: function(e, msg) {
                    console.error('åœ–ç‰‡åŠ è¼‰å¤±æ•—ï¼š', {
                        å…ƒç´ : e.target,
                        è¨Šæ¯: msg,
                        åœ–ç‰‡ä¾†æº: e.target.src,
                        å®Œæ•´æ¶ˆæ¯å°è±¡: msg
                    });
                    
                    // å˜—è©¦å…¶ä»–å¯èƒ½çš„åœ–ç‰‡å±¬æ€§
                    if (e.target.src !== msg.Url && msg.Url) {
                        console.log('å˜—è©¦ä½¿ç”¨ Url å±¬æ€§åŠ è¼‰åœ–ç‰‡:', msg.Url);
                        e.target.src = msg.Url;
                        return;
                    }
                    
                    if (e.target.src !== msg.Content && msg.Content) {
                        console.log('å˜—è©¦ä½¿ç”¨ Content å±¬æ€§åŠ è¼‰åœ–ç‰‡:', msg.Content);
                        e.target.src = msg.Content;
                        return;
                    }
                    
                    // å¦‚æœéƒ½å¤±æ•—äº†ï¼Œé¡¯ç¤ºéŒ¯èª¤åœ–ç‰‡
                    e.target.src = '/web/asset/images/image-error.png';
                    mui.toast('åœ–ç‰‡åŠ è¼‰å¤±æ•—');
                },
                
                // åœ–ç‰‡åŠ è¼‰æˆåŠŸ
                handleImageSuccess: function(e, msg) {
                    console.log('åœ–ç‰‡åŠ è¼‰æˆåŠŸï¼š', {
                        å…ƒç´ : e.target,
                        åœ–ç‰‡ä¾†æº: e.target.src,
                        å¯¬é«˜: {
                            width: e.target.naturalWidth,
                            height: e.target.naturalHeight
                        },
                        æ¶ˆæ¯å°è±¡: msg
                    });
                    
                    this.imageLoaded = true;
                },
                
                // é è¦½åœ–ç‰‡
                previewImage: function(url) {
                    if (!url) {
                        console.error('ç„¡æ•ˆçš„åœ–ç‰‡URL');
                        return;
                    }
                    
                    console.log('æº–å‚™é è¦½åœ–ç‰‡:', url);
                    
                    // ç¢ºä¿ URL æ˜¯å®Œæ•´çš„
                    const fullUrl = url.startsWith('http') ? url : 
                                  url.startsWith('/') ? window.location.origin + url : 
                                  window.location.origin + '/' + url;
                    
                    console.log('ä½¿ç”¨å®Œæ•´è·¯å¾‘é è¦½åœ–ç‰‡:', fullUrl);
                    
                    // å‰µå»ºé è¦½å®¹å™¨
                    const previewContainer = document.createElement('div');
                    previewContainer.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 9999;
                    `;
                    
                    // å‰µå»ºåœ–ç‰‡å…ƒç´ 
                    const img = document.createElement('img');
                    img.src = fullUrl;
                    img.style.cssText = `
                        max-width: 90%;
                        max-height: 90%;
                        object-fit: contain;
                    `;
                    
                    // æ·»åŠ åŠ è¼‰ç‹€æ…‹
                    const loadingText = document.createElement('div');
                    loadingText.textContent = 'åœ–ç‰‡åŠ è¼‰ä¸­...';
                    loadingText.style.cssText = `
                        color: white;
                        font-size: 18px;
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                    `;
                    previewContainer.appendChild(loadingText);
                    
                    // åœ–ç‰‡åŠ è¼‰å®Œæˆå¾Œ
                    img.onload = function() {
                        console.log('é è¦½åœ–ç‰‡åŠ è¼‰æˆåŠŸ');
                        previewContainer.removeChild(loadingText);
                        previewContainer.appendChild(img);
                    };
                    
                    // åœ–ç‰‡åŠ è¼‰å¤±æ•—
                    img.onerror = function() {
                        console.error('é è¦½åœ–ç‰‡åŠ è¼‰å¤±æ•—:', fullUrl);
                        loadingText.textContent = 'åœ–ç‰‡åŠ è¼‰å¤±æ•—';
                    };
                    
                    // é»æ“Šé—œé–‰é è¦½
                    previewContainer.onclick = function() {
                        document.body.removeChild(previewContainer);
                    };
                    
                    document.body.appendChild(previewContainer);
                },
                // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å¯ä»¥è¨ªå•
                checkImageExists: function(url) {
                    return new Promise((resolve, reject) => {
                        if (!url) {
                            resolve(false);
                            return;
                        }
                        
                        // ç¢ºä¿å®Œæ•´URL
                        const fullUrl = url.startsWith('http') ? url : 
                                      window.location.origin + (url.startsWith('/') ? url : '/' + url);
                        
                        console.log('æª¢æŸ¥åœ–ç‰‡URLå¯è¨ªå•æ€§:', fullUrl);
                        
                        // ç›´æ¥å˜—è©¦åœ¨é é¢ä¸Šæ·»åŠ ä¸€å€‹æ¸¬è©¦åœ–ç‰‡
                        this.testImageDirectly(fullUrl);
                        
                        const img = new Image();
                        img.onload = function() {
                            resolve(true);
                        };
                        img.onerror = function() {
                            resolve(false);
                        };
                        img.src = fullUrl;
                        
                        // è¨­ç½®è¶…æ™‚
                        setTimeout(() => {
                            resolve(false);
                        }, 5000);
                    });
                },
                // ç›´æ¥æ¸¬è©¦åœ–ç‰‡URL
                testImageDirectly: function(imageUrl) {
                    console.log('ç›´æ¥æ¸¬è©¦åœ–ç‰‡URL:', imageUrl);
                    
                    // å»ºç«‹æ¸¬è©¦å®¹å™¨
                    const testContainer = document.createElement('div');
                    testContainer.id = 'image-test-container';
                    testContainer.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: white;
                        border: 1px solid #ccc;
                        padding: 10px;
                        z-index: 9999;
                    `;
                    
                    // å»ºç«‹åœ–ç‰‡å…ƒç´ 
                    const testImage = document.createElement('img');
                    testImage.src = imageUrl;
                    testImage.style.cssText = `
                        max-width: 100px;
                        max-height: 100px;
                        display: block;
                    `;
                    
                    // æ·»åŠ URLæ–‡å­—
                    const urlText = document.createElement('div');
                    urlText.textContent = 'æ¸¬è©¦åœ–ç‰‡: ' + imageUrl;
                    urlText.style.cssText = `
                        font-size: 10px;
                        word-break: break-all;
                        margin-top: 5px;
                    `;
                    
                    // ç›£è½åœ–ç‰‡è¼‰å…¥äº‹ä»¶
                    testImage.onload = function() {
                        testContainer.style.borderColor = 'green';
                        console.log('æ¸¬è©¦åœ–ç‰‡è¼‰å…¥æˆåŠŸ');
                    };
                    
                    testImage.onerror = function() {
                        testContainer.style.borderColor = 'red';
                        console.error('æ¸¬è©¦åœ–ç‰‡è¼‰å…¥å¤±æ•—');
                    };
                    
                    // æ·»åŠ é—œé–‰æŒ‰éˆ•
                    const closeButton = document.createElement('button');
                    closeButton.textContent = 'é—œé–‰';
                    closeButton.style.cssText = `
                        margin-top: 5px;
                        width: 100%;
                    `;
                    closeButton.onclick = function() {
                        document.body.removeChild(testContainer);
                    };
                    
                    // æ·»åŠ åˆ°é é¢
                    testContainer.appendChild(testImage);
                    testContainer.appendChild(urlText);
                    testContainer.appendChild(closeButton);
                    
                    // ç§»é™¤èˆŠçš„æ¸¬è©¦å®¹å™¨
                    const oldContainer = document.getElementById('image-test-container');
                    if (oldContainer) {
                        document.body.removeChild(oldContainer);
                    }
                    
                    document.body.appendChild(testContainer);
                },
                
                // ç·Šæ€¥æ¨¡å¼ï¼šç›´æ¥åœ¨èŠå¤©ç•Œé¢é¡¯ç¤ºåœ–ç‰‡
                emergencyDisplayImage: function(imageUrl) {
                    console.log('ç·Šæ€¥æ¨¡å¼ï¼šç›´æ¥é¡¯ç¤ºåœ–ç‰‡', imageUrl);
                    
                    // ç¢ºä¿æœ‰èŠå¤©å®¹å™¨
                    const chatThread = document.querySelector('.chat-thread');
                    if (!chatThread) {
                        console.error('æ‰¾ä¸åˆ°èŠå¤©å®¹å™¨ .chat-thread');
                        return;
                    }
                    
                    // å‰µå»ºä¸€å€‹æ–°çš„èŠå¤©æ¶ˆæ¯å…ƒç´ 
                    const li = document.createElement('li');
                    li.className = 'chat mine';
                    
                    // æ·»åŠ é ­åƒ
                    const avatarDiv = document.createElement('div');
                    const avatarImg = document.createElement('img');
                    avatarImg.className = 'avatar right';
                    avatarImg.src = this.info.icon || '/web/asset/images/avatar0.png';
                    avatarDiv.appendChild(avatarImg);
                    
                    // æ·»åŠ ç©ºç™½span
                    const span = document.createElement('span');
                    
                    // æ·»åŠ å…§å®¹å®¹å™¨
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'content';
                    
                    // æ·»åŠ åœ–ç‰‡å®¹å™¨
                    const imageContainerDiv = document.createElement('div');
                    imageContainerDiv.className = 'image-container';
                    
                    // æ·»åŠ åœ–ç‰‡
                    const img = document.createElement('img');
                    img.className = 'pic';
                    img.src = imageUrl;
                    img.alt = 'åœ–ç‰‡æ¶ˆæ¯';
                    img.onclick = () => this.previewImage(imageUrl);
                    
                    // æ§‹å»ºDOMçµæ§‹
                    imageContainerDiv.appendChild(img);
                    contentDiv.appendChild(imageContainerDiv);
                    
                    li.appendChild(avatarDiv);
                    li.appendChild(span);
                    li.appendChild(contentDiv);
                    
                    // æ·»åŠ åˆ°èŠå¤©ç•Œé¢
                    chatThread.appendChild(li);
                    
                    // æ»¾å‹•åˆ°åº•éƒ¨
                    setTimeout(() => {
                        window.scrollTo(0, document.getElementById("convo").offsetHeight);
                        let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                        let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                        let y = scroll - inner - 80;
                        document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                    }, 100);
                },
                
                // æ·»åŠ è¨ºæ–·å·¥å…·
                addDiagnosticTools: function() {
                    // ç§»é™¤èˆŠçš„è¨ºæ–·å·¥å…·
                    const oldTools = document.getElementById('diagnostic-tools');
                    if (oldTools) {
                        document.body.removeChild(oldTools);
                    }
                    
                    // å‰µå»ºè¨ºæ–·å·¥å…·å®¹å™¨
                    const toolsContainer = document.createElement('div');
                    toolsContainer.id = 'diagnostic-tools';
                    toolsContainer.style.cssText = `
                        position: fixed;
                        bottom: 70px;
                        right: 10px;
                        background: rgba(255, 255, 255, 0.9);
                        border: 1px solid #ccc;
                        padding: 10px;
                        z-index: 9999;
                        border-radius: 5px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    `;
                    
                    // æ·»åŠ æ¨™é¡Œ
                    const title = document.createElement('div');
                    title.textContent = 'è¨ºæ–·å·¥å…·';
                    title.style.fontWeight = 'bold';
                    title.style.marginBottom = '10px';
                    
                    // æ·»åŠ æª¢æŸ¥æŒ‰éˆ•
                    const checkBtn = document.createElement('button');
                    checkBtn.textContent = 'æª¢æŸ¥åœ–ç‰‡å…ƒç´ ';
                    checkBtn.style.display = 'block';
                    checkBtn.style.margin = '5px 0';
                    checkBtn.style.width = '100%';
                    checkBtn.onclick = () => this.checkAllImages();
                    
                    // æ·»åŠ å¼·åˆ¶æ›´æ–°æŒ‰éˆ•
                    const updateBtn = document.createElement('button');
                    updateBtn.textContent = 'å¼·åˆ¶æ›´æ–°è¦–åœ–';
                    updateBtn.style.display = 'block';
                    updateBtn.style.margin = '5px 0';
                    updateBtn.style.width = '100%';
                    updateBtn.onclick = () => {
                        console.log('å¼·åˆ¶æ›´æ–°è¦–åœ–');
                        this.$forceUpdate();
                        setTimeout(() => this.checkAllImages(), 100);
                    };
                    
                    // æ·»åŠ é¡¯ç¤ºæ¶ˆæ¯çµæ§‹æŒ‰éˆ•
                    const showMsgBtn = document.createElement('button');
                    showMsgBtn.textContent = 'é¡¯ç¤ºæ¶ˆæ¯çµæ§‹';
                    showMsgBtn.style.display = 'block';
                    showMsgBtn.style.margin = '5px 0';
                    showMsgBtn.style.width = '100%';
                    showMsgBtn.onclick = () => {
                        console.log('é¡¯ç¤ºæ¶ˆæ¯åˆ—è¡¨:', JSON.stringify(this.msglist, null, 2));
                    };
                    
                    // æ·»åŠ é¡¯ç¤ºDOMçµæ§‹æŒ‰éˆ•
                    const showDomBtn = document.createElement('button');
                    showDomBtn.textContent = 'é¡¯ç¤ºDOMçµæ§‹';
                    showDomBtn.style.display = 'block';
                    showDomBtn.style.margin = '5px 0';
                    showDomBtn.style.width = '100%';
                    showDomBtn.onclick = () => {
                        const chatThread = document.querySelector('.chat-thread');
                        console.log('èŠå¤©å®¹å™¨çµæ§‹:', chatThread ? chatThread.innerHTML : 'æ‰¾ä¸åˆ°èŠå¤©å®¹å™¨');
                    };
                    
                    // æ·»åŠ é—œé–‰æŒ‰éˆ•
                    const closeBtn = document.createElement('button');
                    closeBtn.textContent = 'é—œé–‰å·¥å…·';
                    closeBtn.style.display = 'block';
                    closeBtn.style.margin = '5px 0';
                    closeBtn.style.width = '100%';
                    closeBtn.style.marginTop = '10px';
                    closeBtn.onclick = function() {
                        document.body.removeChild(toolsContainer);
                    };
                    
                    // æ§‹å»ºDOMçµæ§‹
                    toolsContainer.appendChild(title);
                    toolsContainer.appendChild(checkBtn);
                    toolsContainer.appendChild(updateBtn);
                    toolsContainer.appendChild(showMsgBtn);
                    toolsContainer.appendChild(showDomBtn);
                    toolsContainer.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é é¢
                    document.body.appendChild(toolsContainer);
                },
                processMessageQueue: function() {
                    if (!this.messageQueue || this.messageQueue.length === 0) {
                        console.log("æ¶ˆæ¯éšŠåˆ—ç‚ºç©ºï¼Œç„¡éœ€è™•ç†");
                        return;
                    }
                    
                    console.log(`è™•ç†æ¶ˆæ¯éšŠåˆ—ï¼Œå…±æœ‰ ${this.messageQueue.length} æ¢å¾…ç™¼é€æ¶ˆæ¯`);
                    
                    if (this.webSocket && this.webSocket.readyState === 1) {
                        // ä¾æ¬¡ç™¼é€éšŠåˆ—ä¸­çš„æ¶ˆæ¯
                        while (this.messageQueue.length > 0) {
                            const msg = this.messageQueue.shift();
                            console.log("å¾éšŠåˆ—ç™¼é€æ¶ˆæ¯:", msg);
                            this.webSocket.send(JSON.stringify(msg));
                        }
                        console.log("æ¶ˆæ¯éšŠåˆ—è™•ç†å®Œæˆ");
                    } else {
                        console.warn("WebSocket é€£æ¥æœªå°±ç·’ï¼Œç„¡æ³•è™•ç†æ¶ˆæ¯éšŠåˆ—");
                    }
                },
            },
            watch: {
                "win": function (n, o) {
                    // console.log("watch",o,n)
                    if (n != "main") {
                        document.getElementById("menubar").style.display = "none";
                    } else {
                        document.getElementById("menubar").style.display = "block";
                    }
                }
            }
        }
    )

</script>
{{end}}